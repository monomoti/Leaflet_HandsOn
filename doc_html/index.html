<!DOCTYPE html>
<html lang="ja">
	<head>
    <!-- Meta, title, CSS, favicons, etc. -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="">
		<link rel="stylesheet" href="./css/bootstrap.min.css">
		<link rel="stylesheet" href="./css/bootstrap-theme.min.css">
		<script src="./js/jquery-1.10.2.min.js"></script>
		<script src="./js/bootstrap.min.js"></script>
		<style type="text/css" media="screen">
		.honbun div{
      margin:100px;
		}
		
		hr{
		  margin-bottom:80px;
		}
			
		</style>
		<script type="text/javascript" charset="utf-8">
			$(function(){
        // var onWindowResize = function(){
        //  $(".my-side-nav").height($(window).height() - 10);
        // };
        // $(window).on("resize",onWindowResize);
        // 
        // onWindowResize();
	
			});
			
		</script>
		
	</head>
	<body>

    <nav id="navbar-example" class="navbar navbar-default  navbar-fixed-top" role="navigation">
      <div class="navbar-header">
        <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-js-navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#">Leaflet Hands-On</a>
      </div>
      <div class="collapse navbar-collapse bs-js-navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="dropdown">
            <a id="drop1" href="#" role="button" class="dropdown-toggle" data-toggle="dropdown">Leaflet入門 <b class="caret"></b></a>
            <ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#intro">はじめに</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e01">Map</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e02">Marker</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e04">Polyline</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e05">Areas</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e06">Events</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e07">LayerGroup & FeatureGroup</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e08">GeoJson</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#e09">Control</a></li>
            </ul>
          </li>
          <li class="dropdown">
            <a href="#" id="drop2" role="button" class="dropdown-toggle" data-toggle="dropdown">実践Backbone.js + Leaflet<b class="caret"></b></a>
            <ul class="dropdown-menu" role="menu" aria-labelledby="drop2">
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#app-intro">
                概要
              </a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#a01">Step01 Leafletの導入</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#a02">Step02 地図を表示する</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#a03">Step03 レイヤとフィーチャーのビュー</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#a04">Step04 エディターコントロール</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#a05">Step05 データの追加</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#a06">Step06 データの変更</a></li>
              <li role="presentation"><a role="menuitem" tabindex="-1" href="#a07">Step07 データの削除</a></li>

            </ul>
          </li>
        </ul>
      </div><!-- /.nav-collapse -->
    </nav> <!-- /navbar-example-->

	  
		<div class="container">
			<div class="row">
				<div class="col-md-12">
				  <hr id="intro">
					<div>
						<h2>
							はじめに
						</h2>
						<p>
							みなさんこんにちは。これから<a target ="_blank" href="http://leafletjs.com">Leaflet</a>のハンズオンセッションを始めます。
						</p>
						<p>
							Leafletは総ファイルサイズが約31KBと軽量で、滑らな動作と洗練されたスタイリングが特徴の、JavaScriptのWebマップAPIです。	モバイルデバイスでの使用もよく考慮して設計されています。<br>
							現在のヴァージョンは0.6というまだ若いAPIで、最近<a target="_blank" href="http://www.openstreetm	ap.org">OpenStreetMap</a>のWebサイトに採用された事で、はじめてLeafletの名を知ったという方もいらっしゃるのではないでしょうか。
						</p>	
						</p>
						<p>このセッションの前半では、JavaSciptやHTMLのコードをタイプしながら、下記のLeafletの基本的な項目について学びます。</p>
						<ul>
							<li>Map - ベースの地図を表示する</li>
							<li>Layers - オーバーレイの表示、スタイリング</li>
							<li>Events - 地図やオーバーレイとのインタラクション</li>
							<li>Layer Group & Feature Group</li>
							<li>GeoJSON</li>
							<li>Control - 定義済みコントロールとカスタムコントロール </li>
						</ul>
						<p>後半では、前半で学んだ事ををベースにして、JavaScriptのアプリケーションフレームワーク Backbone.jsと組み合わせたWebアプリケーションを作成します。</p>
					</div>
					<hr id="e01">
					<div>
						<h2>Leaflet入門</h2>
						
						<h3>Map</h3>
						
<!-- 
						<p>それでは始めましょう。</p>
						
						<p>ターミナルを開き、下記を実行してください。</p>

						<p>下記のフォルダを開いてください。</p>
						<code>＜教材をコピーしたフォルダ＞/basics/ex</code>
						<br><br>
						<p>前半はこのディレクトリで作業します。</p>

						<p>ターミナルで、下記を実行して、webサーバを起動します。</p>
						<code>
							$ cd ＜教材をコピーしたフォルダ＞/basics/ex<br>
							$ jekyll serve --watch

						</code>
						<br><br>
-->
						<p>
							さあ、始めましょう。テキストエディタで、＜教材をコピーしたフォルダ＞/basics/ex/index.htmlを開いてください。
						</p>
						<p>まず、leafletのjavascriptとスタイルシートへのリンクを挿入して、を使える状態にしましょう。</p>
						<p>必要なファイルは、./jsディレクトリにあります。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">&lt;script src=<font style="color:brown;">"./js/leaflet/leaflet.js"</font> type=<font style="color:brown;">"text/javascript"</font> charset=<font style="color:brown;">"utf-8"</font>&gt;&lt;/script&gt;</li>
						<li style="background-color:#EEF;">&lt;link rel=<font style="color:brown;">"stylesheet"</font> href=<font style="color:brown;">"./js/leaflet/leaflet.css"</font> /&gt;</li>
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">&lt;!--[if lte IE 8]&gt;&lt;link rel="stylesheet" href="./js/leaflet/leaflet.ie.css" /&gt;&lt;![endif]--&gt;</font></li>
						</ol></code>

						<p>次に、地図のコンテナとなるdiv要素をbodyに入れます。</p>

            <code>
            <ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
            <li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;</li>
            <li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;</li>
<strong>            
            <li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;  &lt;div id=<font style="color:brown;">"map"</font>&gt;&lt;/div&gt;</li>
</strong>            
            <li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;</li>
            <li style="background-color:#EFF;">&lt;/html&gt;</li>
            </ol></code>

						<p>
						地図を表示するコードを書いてみましょう。<br>
						Leafletにあまり関係のないコーディングの手間を省くため、jQuery(1.10.2)を使用します<br>
						※URLや座標など、タイプするのが面倒なデータはこのhtml文書からコピー＆ペーストしいていただいてかまいません。<br>
						</p>

            <code>
            <ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
            <li style="background-color:#EFF;">&lt;script type=<font style="color:brown;">"text/javascript"</font> charset=<font style="color:brown;">"utf-8"</font>&gt;</li>
<strong>            
            <li style="background-color:#EEF;">&nbsp;&nbsp;$(function(){</li>
            <li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var map = new L.Map(<font style="color:brown;">"map"</font>).setView(new L.LatLng(34.7067,135.45), 12),</li>
            <li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;baseLayer = new L.TileLayer(<font style="color:brown;">'http://{s}.tile.cloudmade.com/77b7b2219a944c3cbf118035611d6dae/997/256/{z}/{x}/{y}.png'</font>,</li>
            <li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;{</li>
            <li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;minZoom:2,</li>
            <li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;maxZoom:20,</li>
            <li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;attribution: <font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, '</font></li>
            <li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <font style="color:brown;">'Imagery &amp;copy; &lt;a href="http://cloudmade.com"&gt;CloudMade&lt;/a&gt;'</font></li>
            <li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
            <li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;map.addLayer(baseLayer);</li>
            <li style="background-color:#EEF;">&nbsp;&nbsp;});</li>
</strong>            
            <li style="background-color:#EFF;"></li>
            <li style="background-color:#EEF;">&lt;/script&gt;</li>
            <li style="background-color:#EFF;"></li>
            </ol></code>
            <br><br>

						<p>
						このコードでしている事は:
						<ol>
						<li>L.Mapオブジェクト（以降、このオブジェクトの事を「マップ」と呼ぶことにします）を作成し、中心の緯度経度(緯度34.7067、経度135.45)とズームレベル（12）を設定。初期化メソッドの引数"map"は、地図コンテナdivのidです。<br><br></li>
						<li>必須の引数に地図タイルのURL、オプションに最大・最小のズームレベル、コピーライトを指定して、L.TileLayerのオブジェクト（=タイルレイヤ）を作成。<br><br></li>
						<li>マップにタイルレイヤを追加。<br><br></li>
						</ol>
						</p>
						<p>
							この説明でお分かりのように、マップは「地図」というよりは、地図を表示する為の「無地のキャンバス」や、地図系機能を提供する「箱」のようなものととらえるべきでしょう。
						</p>
						<p>
						また、地図コンテナのdivには、必ず高さを指定する必要があります。
						スタイルシートで固定の高さを指定してもよいですが、ここでは常にウィンドウいっぱいに地図が表示されるように、コードを書いてみましょう。
						</p>
						
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">$(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var map = new L.Map(<font style="color:brown;">"map"</font>).setView(new L.LatLng(34.7067,135.45), 12),</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;baseLayer = new L.TileLayer(<font style="color:brown;">'http://{s}.tile.cloudmade.com/77b7b2219a944c3cbf118035611d6dae/997/256/{z}/{x}/{y}.png'</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;minZoom:2,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;maxZoom:20,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;attribution: <font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, '</font></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;+ <font style="color:brown;">'Imagery &amp;copy; &lt;a href="http://cloudmade.com"&gt;CloudMade&lt;/a&gt;'</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;map.addLayer(baseLayer);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;var onWindowResize = function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(<font style="color:brown;">"#map"</font>).height($(window).height() - 10);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.invalidateSize();</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;};</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;$(window).on(<font style="color:brown;">"resize"</font>,onWindowResize);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;onWindowResize();</li>
</strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>ブラウザで下記URLを開いて、確認してみましょう。</p>
						<p><a target="_blank" href="../basics/ex/index.html"><code>../basics/ex/index.html</code></a></p>

						<p>ブラウザのサイズを変えても、地図が全体に表示されていると思います。<br>
						map.invalidateSize()は新しいコンテナのサイズに合わせてmapを再描画します。</p>

						<p>ところで、Leafletの各クラスには、下記のように、クラス名の最初の文字を小文字にしたオブジェクト初期化メソッドが用意されています。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">L.klass = function(初期化引数){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;return new L.Klass(初期化引数)</li>
						<li style="background-color:#EFF;">};</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>


						<p>つまり地図を表示するコードは、下記のように書き換えることができます。</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// new L.Klassは l.klassに変更可能</font></li>
						<li style="background-color:#EEF;">var map = <strong>L.map</strong>(<font style="color:brown;">"map"</font>).setView(<strong>L.latLng</strong>(34.7067,135.45), 12),</li>
						<li style="background-color:#EFF;">baseLayer = <strong>L.tileLayer</strong>(<font style="color:brown;">'http://{s}.tile.cloudmade.com/77b7b2219a944c3cbf118035611d6dae/997/256/{z}/{x}/{y}.png'</font>,</li>
						<li style="background-color:#EEF;">{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;minZoom:2,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;maxZoom:20,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;attribution:<font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, '</font></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;+ <font style="color:brown;">'Imagery &amp;copy; &lt;a href="http://cloudmade.com"&gt;CloudMade&lt;/a&gt;'</font>,</li>
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;">map.addLayer(baseLayer);</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>


						<p>また、マップにレイヤを追加するところは、下記のように書き換えることができます。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">baseLayer.addTo(map);</li>
						</ol></code>

						<p>
						L.TileLayerのサブクラスL.TileLayer.WMSを使うと、Web Map Serviceのレイヤを表示することができます。<br>
						タイルレイヤの上に、WMSのレイヤを追加してみましょう。<br>
						<span class="text-warning">
							動作が確認できたら、この後の自習の為にこのコードは消しておきましょう。
						</span>
					</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var nexrad = L.tileLayer.wms(<font style="color:brown;">"http://www.finds.jp/ws/kiban2500wms.cgi"</font>, {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;layers: <font style="color:brown;">'KIBAN2500'</font>,<font style="color:green;font-style:italic;">//'nexrad-n0r-900913',</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;format: <font style="color:brown;">'image/png'</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;transparent: true,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;attribution: <font style="color:brown;">"独立行政法人 農業・食品産業技術総合研究機構 近畿中国四国農業研究センター"</font>,</li>
						<li style="background-color:#EEF;">}).addTo(map);</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>
						
					</div>
					<hr id="e02">
					<div>
						<h3>Marker</h3>
						<p>
						地図の上にオーバーレイを表示しましょう。まずは点のデータをL.Markerで表現しましょう。
						</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var points =[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(35.902538923668644,139.93895530700684),</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(34.707178025105534,135.49422919750214)</li>
						<li style="background-color:#EEF;">];</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">(function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.marker(points[i]).addTo(map);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">})();</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>地図上に2点表示されているのが確認できたでしょうか。マーカーにオプションを設定して、見た目をかえてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var points =[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(35.902538923668644,139.93895530700684),</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(34.707178025105534,135.49422919750214)</li>
						<li style="background-color:#EEF;">];</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">(function(){</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var myIcon = L.icon({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconUrl:<font style="color:brown;">"./images/chitei_sweat.png"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconRetinaUrl:<font style="color:brown;">"./images/chitei_sweat-2x.png"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconSize:[48,61],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconAnchor:[24,61],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowUrl:<font style="color:brown;">"./images/shadow-chitei_sweat.png"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowRetinaUrl:<font style="color:brown;">"./images/shadow-chitei_sweat-2x.png"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowSize:[79.61],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowAnchor:[10,61]</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
</strong>						
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.marker(points[i]<strong>,{icon:myIcon}</strong>).addTo(map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">})();</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>
							ブラウザで確認してみましょう。何が表示されていますか？OSGeo.jpのキャラクター、地底人になっているでしょうか。
						</p>
						<p>コードを解説します。<br>
						L.Iconクラスのオブジェクトを作成して、Markerのiconオプションに設定しています。<br>
						アイコンとアイコンの影の画像について、URL（通常ディスプレイ用とRetina用）、画像サイズ、アンカーの位置を指定しています。<br>
						アンカーは、画像の左上をx=0,y=0とするピクセル座標です。<br>
						これを[0,0]とした場合、Markerは指定した緯度経度位置に画像の左上にくるように配置されます。
						</p>
						<p>マーカーのアイコンをHTMLのdiv要素にする事もできます。やってみましょう。<br>
						まず、スタイルシートに、マーカーに用いるdivのスタイルを設定しておきます。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">&lt;style type=<font style="color:brown;">"text/css"</font> media=<font style="color:brown;">"screen"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;body{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin:0;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;.my-div-icon{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:yellow;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;background-color:green;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EFF;">&lt;/style&gt;</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>
						
						<p>コードを次のようにかえてみましょう。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>
						<li style="background-color:#EFF;">var myDivIconClass = L.DivIcon.extend({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;statics:{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defaultSize:L.point(200,100),</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">});</li>
</strong>						
						<li style="background-color:#EEF;">(function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.marker(points[i],{</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;icon:new myDivIconClass({</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconSize:myDivIconClass.defaultSize,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;html:<font style="color:brown;">"地底人、"</font> + <font style="color:brown;">"&lt;br&gt;"</font> + points[i].lat + <font style="color:brown;">",&lt;br&gt; "</font> + points[i].lng + <font style="color:brown;">"&lt;br&gt; に出没！！"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;className:<font style="color:brown;">"my-div-icon"</font></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</li>
</strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;).addTo(map);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">})();</li>
						</ol></code>
						
						<p>
							ブラウザで確認してみましょう。
						</p>
						<p>&nbsp</p>
						
					</div>
					<hr id="e04">
					<div>
						<h3>Polyline</h3>
						<p>
						次は、ベクターのオーバーレイを入れてみましょう。<br>
						まずは、線を表現するベクター、ポリライン(L.Polyline)です。座標は、L.LatLngオブジェクトの配列で定義します。<br>
						2本入れてみましょう。
						</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var lines = [</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;[</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.68404023638139,135.3676986694336],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.69194468425019,135.37250518798828],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.699001589175694,135.37593841552732],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70634013194013,135.38005828857422],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.713395809196285,135.38280487060547],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.7198865006899,135.3852081298828],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.72327274617847,135.3841781616211],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.728069689872314,135.38108825683594],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.73117344628392,135.38040161132812],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.735405653558466,135.38074493408203],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.73991976908823,135.38074493408203],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.74584417145821,135.37731170654297],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.75233231513258,135.37490844726562],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.7602302368772,135.3738784790039],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.76389687232034,135.3752517700195],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.767845374513804,135.37593841552732],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.77151167170742,135.37456512451172],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.77545980961412,135.37456512451172],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.78250958602015,135.37353515625],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.78955875999958,135.37181854248047],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.79209631514749,135.36975860595703]</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.69646117272349,135.40958404541016],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70097741472011,135.41507720947266],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70521116772807,135.42434692382812],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.707469080745376,135.42949676513672],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71170250154446,135.43155670166016],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.714806872423296,135.44288635253906],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71903991764788,135.44837951660156],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.72411928588024,135.44837951660156],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.732584206123626,135.44769287109375],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.734559229442404,135.45146942138672]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;]</li>
						<li style="background-color:#EFF;">];</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;for(var i=0; i &lt; lines.length; i++){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.polyline(lines[i]).addTo(map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">})();</li>
						</ol></code>

						<p>
						ブラウザで確認してみましょう。ポリラインが2本表示されていますね。
						</p>
						<p>
						では、ポリラインの見た目を整えましょう。L.Polylineのコンストラクタの第2引数にオプションを設定します。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;for(var i=0; i &lt; lines.length; i++){</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.polyline(lines[i],{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#f36"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:0.8,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[15, 15, 5, 15],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).addTo(map);</li>
</strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">})();</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>
						
						<p>
							スタイルはどう変わったでしょうか。
						</p>

						<p>
						dashArrayは、ポリラインのパターンを、
						<code>[描画する長さ(px), 描画しない長さ(px),描画する長さ(px),...]</code>
						という配列で定義します。
						音楽の授業でやった、「打って休んで」みたいですね。<br>
						上の例では、「15px描いて、15px間を空けて、5px描いて、15px空ける」ということになります。
						</p>

						<p>スタイルは、L.Polylineのオブジェクトを作成した後でも、変更することができます。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">(function(){</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;var myStyle = {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#f36"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;opacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[15, 15, 5, 15],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;}</li>
</strong>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;for(var i=0; i &lt; lines.length; i++){</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var pln = L.polyline(lines[i]).addTo(map);</li>
						<li style="background-color:#EFF;"></li>
						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pln.setStyle(myStyle);</li>
</strong>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">})();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>上のコードでは、L.Polylineオブジェクトを作成した後で、setStyleメソッドでスタイルを設定しています。</p>
						
					</div>
					<hr id="e05">
					<div>
						<h3>Areas - Polygon, Rectangle, Circle</h3>
						<p>						
						次は、面を表現するいくつかのベクターを地図に載せてみましょう。
						</p>
						<h4>Polygon</h4>
						<p>
						最初は、ポリゴン(L.Polygon)です。<br>
						座標は、1つの外周のL.LatLngオブジェクトの配列と、0個以上の内周のL.LatLngオブジェクトので定義します。
						</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var polygons = [</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;<font style="color:green;font-style:italic;">/* 一つ目のポリゴン */</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;<font style="color:green;font-style:italic;">/* 外周の配列 */</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.68234632793162,135.37044525146484],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.68926290260606,135.3731918334961],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.695614349908894,135.37628173828125],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70027176815597,135.37782669067383],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.706904608268616,135.3812599182129],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71043249805487,135.38246154785156],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71508908217963,135.38366317749023],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.713960237376156,135.38898468017578],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.713960237376156,135.39087295532227],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71621791157453,135.4003143310547],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71353691660239,135.4003143310547],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.709021360195784,135.40082931518555],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70436443445848,135.39962768554688],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.6932149715449,135.38572311401367],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.69123896066246,135.38211822509766],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.6915212508196,135.37954330444336],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.68615757320979,135.37782669067383],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.6807935480764,135.37267684936523],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.68234632793162,135.37044525146484],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;<font style="color:green;font-style:italic;">/* 内周の配列 */</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.69688458088134,135.38108825683594],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.708598014143604,135.3848648071289],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70831578223847,135.39138793945312],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70168305526641,135.39190292358398],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.69998950784534,135.38949966430664],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.69617889941474,135.3867530822754],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.69688458088134,135.38108825683594]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;],</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:green;font-style:italic;">/* 二つ目のポリゴン */</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;<font style="color:green;font-style:italic;">/* 外周の配列 */</font>&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70817466592478,135.32529830932614],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71678232049371,135.32581329345703],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.72214401309219,135.33113479614258],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.719604307305666,135.33903121948242],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.718052226477106,135.34143447875977],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71071472273777,135.33851623535156],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.71043249805487,135.33336639404297],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70817466592478,135.33302307128906],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[34.70817466592478,135.32529830932614]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;]</li>
						<li style="background-color:#EFF;">];</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;for(var i=0; i &lt; polygons.length; i++){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.polygon(polygons[i]).addTo(map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">})();</li>
						</ol></code>

						<p>
							ブラウザで確認してみましょう。穴のないポリゴンと、穴の開いたポリゴンが表示されていますね。
						</p>

						<p>
						ポリゴンにスタイルを設定して、見た目を整えましょう。
						設定項目はほとんどポリラインと同じですが、塗りつぶしに関する項目があるという違いがあります。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;for(var i=0; i &lt; polygons.length; i++){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.polygon(polygons[i],{</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#556b2f"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#ff8c00"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[20, 10],</li>
</strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).addTo(map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">})();</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<h4>Rectangle</h4>
						<p>
						次は南西端と北東端の座標から得られる長方形の範囲を示す、レクタングル(L.Rectangle)です。
						座標の指定に用いるのは、L.LatLngBoundsクラスのオブジェクトです。
						</p>
						<p>L.LatLngBoundsのオブジェクトは、下記のようにして作成します。</p>

						<code>
						<ol style="list-style:none outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var southWest = new L.LatLng(34.967, 135.84045),</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;northEast = new L.LatLng(35.50987, 136.26892),</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;bounds1 = new L.LatLngBounds(southWest, northEast);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">var bounds2 = new L.LatLngBounds([34.967, 135.84045],[35.50987, 136.26892]);    </li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>ではレクタングルを地図に載せてみましょう。スタイルの指定方法は、L.Polylineと同じです。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var bound = [[34.72284947307697,135.33302307128906],&nbsp;&nbsp;&nbsp;&nbsp;[34.73991976908823,135.3632354736328]];</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;L.rectangle(bound,{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#ff0000"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:2,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#696969"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[30, 10],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}).addTo(map);</li>
						<li style="background-color:#EFF;">})();</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<h4>Circle</h4>	
						<p>
						どんどん行きましょう。次は中心緯度経度と半径から得られる円を描くサークル(L.Circle)です。<br>
						初期化メソッドの引数は、第一引数が中心座標、第二引数が半径（単位はメートル）、あとはオプションです。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var circle = {position:[34.73060913560536,135.40460586547852],radius:700};</li>
						<li style="background-color:#EEF;">(function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;L.circle(circle.position,circle.radius,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#000"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#ffd700"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[10, 10],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;}).addTo(map);      </li>
						<li style="background-color:#EEF;">})();</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<h4>Circle Marker</h4>	
						<p>
						L.Circleと似た名前のL.CircleMarkerというクラスがあります。<br>
						L.Circleとの違いは、半径の指定が必須ではなく、メートルではなくピクセル値として評価される事です。<br>
						半径を指定しない場合、デフォルトの10pxが適用されます。
						</p>
						<p>先ほどのL.Circleで使ったデータと同じデータで、地図に載せてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;L.circleMarker(circle.position,{</li>
<strong>							
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;  radius:circle.radius * 0.025,</li>
</strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#00f"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:0.8,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#f00"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}).addTo(map);</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">})();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>ズームイン／アウトしてみると、赤い塗りつぶしの円の大きさが常に一定である事が分かるでしょう。</p>
						<br><br>
					</div>
					<hr id="e06">
					<div>
						<h3>Events</h3>
						
						<p>ここまで、Leafletの様々なオブジェクトの表示の仕方を学んできました。次は、これらのオブジェクトとインタラクションができるようにしてみましょう。</p>
						<br>
						<h4>
							レイヤーオブジェクト（オーバーレイ）のイベントとインタラクション
						</h4>
						<p>
						地底人にマウスオーバーすると、別のアイコンに変わるようにしてみましょう。<br>
						マウスオーバーしたときのアイコンを用意します。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var points =[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(35.902538923668644,139.93895530700684),</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(34.707178025105534,135.49422919750214)</li>
						<li style="background-color:#EEF;">];</li>
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var myIcon = L.icon({</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;    iconUrl:<font style="color:brown;">"./images/chitei_sweat.png"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;    iconRetinaUrl:<font style="color:brown;">"./images/chitei_sweat-2x.png"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;    iconSize:[48,61],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;    iconAnchor:[24,61],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;    shadowUrl:<font style="color:brown;">"./images/shadow-chitei_sweat.png"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;    shadowRetinaUrl:<font style="color:brown;">"./images/shadow-chitei_sweat-2x.png"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;    shadowSize:[79.61],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;    shadowAnchor:[10,61]</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;var myOnIcon = L.icon({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconUrl:<font style="color:brown;">"./images/chitei_r_back.png"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconRetinaUrl:<font style="color:brown;">"./images/chitei_r_back-2x.png"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconSize:[51,65],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iconAnchor:[25,65],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowUrl:<font style="color:brown;">"./images/shadow-chitei_r_back.png"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowRetinaUrl:<font style="color:brown;">"./images/shadow-chitei_r_back-2x.png"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowSize:[84.65],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shadowAnchor:[10,65]</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;});&nbsp;&nbsp;&nbsp;&nbsp;</li>
</strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.marker(points[i],{icon:myIcon}).addTo(map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">})();</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>
						
						<p>
						L.Markerオブジェクトのonというメソッドを使って、マウスオーバーのイベントが発生したときの動作を定義します。<br>
						onメソッドの第一引数にイベント名、第二引数にイベント発生時の処理（リスナーファンクション）を指定します。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EEF;">&nbsp;L.marker(points[i],{icon:myIcon}).addTo(map)</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;.on(<font style="color:brown;">"mouseover"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;e.target.setIcon(myOnIcon); &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;});</li>
</strong>
						<li style="background-color:#EEF;">}</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>動かしてみましょう。地底人が背中を向けたでしょうか？</p>
						<p>
						ここで、リスナーファンクションのなかでやっている事を解説します。<br>
						mouseoverイベント発生時、リスナーファンクションはL.MouseEventのオブジェクトを引数に取ります。<br>
						このオブジェクトのtargetプロパティで、イベントが発生したオブジェクトを取得することができます。<br>
						ここでは、マウスオーバーしたマーカー（L.Markerオブジェクト）を取得することになります。<br>
						そして、取得したマーカーのsetIconメソッドでアイコンを変更しています。<br>
						</p>
						<p>
						onメソッドの第三引数に、コンテクストを指定することができます。<br>
						コンテクストとは、リスナーファンクションでthisというキーワードで参照されるオブジェクトです。<br>
						この引数を省略すると、thisはイベントが発生したオブジェクト、e.targetと同じオブジェクトになります。<br>
						</p>
						<p>onメソッドにコンテクストをマーカー自身を指定すると、こんな風に書き換えられます。</p>
						<code>
						<ol style="list-style:none outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EEF;">&nbsp;var mk = L.marker(points[i],{icon:myIcon}).addTo(map);</li>
						<li style="background-color:#EFF;">&nbsp;mk.on(<font style="color:brown;">"mouseover"</font>,function(e){</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;this.setIcon(myOnIcon);</li>
						<li style="background-color:#EFF;">&nbsp;},mk);<font style="color:green;font-style:italic;">// mkを省略してもthisはmkを指す</font></li>
</strong>
						<li style="background-color:#EEF;">}</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>それでは、マウスが地底人から離れたときに元のアイコンに戻るようにしてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EEF;">&nbsp;L.marker(points[i],{icon:myIcon}).addTo(map)</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;.on(<font style="color:brown;">"mouseover"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.target.setIcon(myOnIcon);</li>
						<li style="background-color:#EFF;">&nbsp;})</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;.on(<font style="color:brown;">"mouseout"</font>,function(e){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;e.target.setIcon(myIcon);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;});</li>
</strong>						
						<li style="background-color:#EFF;">}</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>
						次に移る前に、もう一点だけ補足します。L.Markerオブジェクトのclickableオプションがfalseになっていると、マウスオーバー／オフ、クリックなどのイベントは発生しません。<br>
						これは、L.Poline,L.Polygonなどのベクターレイヤについても同様です。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// こうするとマウスイベントが起こらなくなる</font></li>
						<li style="background-color:#EEF;">L.marker(points[i],{icon:myIcon,<strong>clickable:false</strong>})addTo(map) </li>
						</ol></code>

						<p>						
						さて、ポリラインとポリゴン、レクタングル、サークルにもにも、マウスオーバー／マウスオフでスタイルが変わるようにしてみましょう。<br>
						スタイルの変更は、setStyleメソッドで行います。
						同じ事を繰り返すのはしんどいので、共通の処理を関数に定義しましょう。このコードはどこに入れてもかまいません。
						</p>
						<p>関数名は、addCommonListenersToVectorで、引数は次のような仕様とします。</p>
						<table class="table">
							<tr>
								<th>
									1.
								</th>
								<td>layer</td>
								<td>
									イベントを監視し、リスナーファンクションを定義する対象のlayerオブジェクト
								</td>
							</tr>
							<tr>
								<th>
									2.
								</th>
								<td>options</td>
								<td>
									"onStyle"キーにマウスオーバー時のスタイル、"offStyle"キーに通常時のスタイルを持つオブジェクト。
								</td>
							</tr>
						</table>
						
						<p>
							では実装してみましょう。
						</p>
						
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var addCommonListenersToVector = function(layer,options){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;layer.on(<font style="color:brown;">"mouseover"</font>,function(e){this.setStyle(options.onStyle)},layer)</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"mouseout"</font>,function(e){this.setStyle(options.offStyle)},layer);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;return layer;</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>ポリライン、ポリゴン、レクタングル、サークルにマウスオーバー時のスタイルを定義して、addCommonListenersToVectorを適用しましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// ポリラインにイベントリスナーファファンクションを設定</font></li>
						<li style="background-color:#EEF;">(function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;var myStyle = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#f36"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;opacity:0.8,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[15, 15, 5, 15],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;var myOnStyle = {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#f36"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;weight:10,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[5, 5],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;};</li>
</strong>						
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;for(var i=0; i &lt; lines.length; i++){</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var pln = L.polyline(lines[i]).addTo(map).setStyle(myStyle);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;addCommonListenersToVector(pln,{offStyle:myStyle,onStyle:myOnStyle});</li>
</strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">})();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>


						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// ポリゴンにイベントリスナーファファンクションを設定</font></li>
						<li style="background-color:#EEF;">(function(){&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var myStyle = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#556b2f"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#ff8c00"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[20, 10],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;};</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var myOnStyle = {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#ff0000"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:3,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#ffff2f"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[20, 10],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;};</li>
</strong>						
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;for(var i=0; i &lt; polygons.length; i++){</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var pgn = L.polygon(polygons[i],myStyle).addTo(map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addCommonListenersToVector(pgn,{offStyle:myStyle,onStyle:myOnStyle});</li>
</strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">})();</li>
						</ol></code>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// レクタングルにイベントリスナーファファンクションを設定</font></li>
						<li style="background-color:#EEF;">(function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var myStyle ={</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#ff0000"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:2,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#696969"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[30, 10],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;};</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var myOnStyle = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:10,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#969696"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:1,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:-1</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;};</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var rect = L.rectangle(bound,myStyle).addTo(map);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;addCommonListenersToVector(rect,{offStyle:myStyle, onStyle:myOnStyle});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
</strong>						
						<li style="background-color:#EFF;">})();</li>

						</ol></code>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// サークルにイベントリスナーファファンクションを設定</font></li>
						<li style="background-color:#EEF;">(function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var myStyle = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#000"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:5,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#ffd700"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[10, 10],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;};</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var myOnStyle = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:0,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#0f0"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:1,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[10, 10],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;};</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var circ = L.circle(circle.position,circle.radius,myStyle).addTo(map);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;addCommonListenersToVector(circ,{offStyle:myStyle,onStyle:myOnStyle});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
</strong>						
						<li style="background-color:#EFF;">})();</li>
						</ol></code>


						<p>他のタイプのイベントも扱ってみましょう。クリックしたときにそのオブジェクトにズームする処理を、先ほどのaddCommonListenersToVectorに入れて下さい。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var addCommonListenersToVector = function(layer,options){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;layer.on(<font style="color:brown;">"mouseover"</font>,function(e){this.setStyle(options.onStyle)},layer)</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"mouseout"</font>,function(e){this.setStyle(options.offStyle)},layer)</li>
						<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"click"</font>,function(e){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.fitBounds(this.getBounds())</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},layer);</li>
						</strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;return layer;</li>
						<li style="background-color:#EFF;">};</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>
						<p>
						clickイベントのリスナーファンクションでは、2つのことをしています。
						<ol>
						<li>ベクターレイヤオブジェクトの.getBounds()メソッドで、緯度経度のベクターの緯度経度範囲（L.LatLngBounds）を取得。<br><br></li>
						<li>取得した緯度経度範囲を引数にして、mapのfitBounds()メソッドを実行。<br><br></li>
						</ol>
						</p>
						<p>ベクターレイヤについて最後にもう一つ。右クリックをしたときにそのベクターレイヤオブジェクトを地図から削除する処理を入れてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var addCommonListenersToVector = function(layer,options){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;layer.on(<font style="color:brown;">"mouseover"</font>,function(e){this.setStyle(options.onStyle)},layer)</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"mouseout"</font>,function(e){this.setStyle(options.offStyle)},layer)</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"click"</font>,function(e){map.fitBounds(this.getBounds())},layer)</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"contextmenu"</font>,function(e){map.removeLayer(this)},layer);</li></strong>
						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;return layer;</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>
						
						<h4>
							マップのイベントとインタラクション
						</h4>
						<p>
						インタラクションの実習の締めくくりに、マップ(L.Map)のイベントと操作について実習します。<br>センターマーカーの実装です。
						</p>
						<p>まずマーカーを地図の中心に置きます。コードを入れる位置は、変数mapの定義の後であればどこでもかまいません。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var map = L.map(<font style="color:brown;">"map"</font>).setView(L.latLng(34.7067,135.45), 12),</li>
						<li style="background-color:#EEF;">baseLayer = L.tileLayer(<font style="color:brown;">'http://{s}.tile.cloudmade.com/77b7b2219a944c3cbf118035611d6dae/997/256/{z}/{x}/{y}.png'</font>,</li>
						<li style="background-color:#EFF;">{</li>
						<li style="background-color:#EEF;">minZoom:2,</li>
						<li style="background-color:#EFF;">maxZoom:20,</li>
						<li style="background-color:#EEF;">attribution: <font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, '</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;+ <font style="color:brown;">'Imagery &amp;copy; &lt;a href="http://cloudmade.com"&gt;CloudMade&lt;/a&gt;'</font></li>
						<li style="background-color:#EEF;">});</li>
						<li style="background-color:#EFF;">map.addLayer(baseLayer);</li>
						<li style="background-color:#EEF;"></li>
<strong>						
						<li style="background-color:#EFF;">var centerMk = L.marker(map.getCenter(),{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;icon:L.icon({iconUrl:<font style="color:brown;">"./images/cmk.gif"</font>,iconSize:[40,40],iconAnchor:[20,20]})</li>
						<li style="background-color:#EFF;">}).addTo(map);</li>
</strong>
						</ol></code>


						<p>地図のスクロール、ズームチェンジを監視して、マーカーが常に地図の中央くるようにします。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var centerMk = L.marker(map.getCenter(),{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;icon:L.icon({iconUrl:<font style="color:brown;">"./images/cmk.gif"</font>,iconSize:[40,40],iconAnchor:[20,20]})</li>
						<li style="background-color:#EFF;">}).addTo(map);</li>
						<li style="background-color:#EEF;"></li>
<strong>						
						<li style="background-color:#EFF;">map.on(<font style="color:brown;">"move"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;centerMk.setLatLng(map.getCenter());</li>
						<li style="background-color:#EFF;">});</li>
</strong>
						</ol></code>
						
						<p>
						これで十分にも思えますが、ズームイン／アウトするときに、マーカーが中心からずれますね。<br>
						ちょっと消極的な解決法ですが、ズームイン／アウトの間はマーカーを表示しないようにしてみましょう。
						</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">map.on(<font style="color:brown;">"move"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;centerMk.setLatLng(map.getCenter());</li>
						<li style="background-color:#EFF;">})</li>
<strong>
						<li style="background-color:#EEF;">.on(<font style="color:brown;">"zoomstart"</font>,function(e){map.removeLayer(centerMk)})</li>
						<li style="background-color:#EFF;">.on(<font style="color:brown;">"zoomend"</font>,function(e){map.addLayer(centerMk)});</li>
</strong>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>これで少しはましにになったのではないでしょうか。</p>
<p>
						時間の都合上詳しい解説はしませんが、ついでにポップアップ(L.Poupup)を紹介しておきます。<br>
						マップやレイヤーオブジェクトに吹き出しを表示する、便利なオブジェクトです。<br>
						下のようにコードを変更して、動作を確かめてみましょう。
						</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>
						<li style="background-color:#EFF;">var popUp = L.popup();</li>
</strong>
						<li style="background-color:#EEF;">var centerMk = L.marker(map.getCenter(),{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;icon:L.icon({iconUrl:<font style="color:brown;">"./images/cmk.gif"</font>,iconSize:[40,40],iconAnchor:[20,20]}),</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}).addTo(map).bindPopup(popUp,{offset:[0,-10]});</li>
</strong>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">map.on(<font style="color:brown;">"move"</font>,function(e){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;centerMk.setLatLng(map.getCenter());</li>
						<li style="background-color:#EEF;">})</li>
						<li style="background-color:#EFF;">.on(<font style="color:brown;">"zoomstart"</font>,function(e){map.removeLayer(centerMk)})</li>
						<li style="background-color:#EEF;">.on(<font style="color:brown;">"zoomend"</font>,function(e){map.addLayer(centerMk)})</li>
<strong>
						<li style="background-color:#EFF;">.on(<font style="color:brown;">"moveend"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var c = this.getCenter()</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;popUp.setContent(<font style="color:brown;">"Lat:"</font> +c.lat + <font style="color:brown;">", Lng:"</font> + c.lng);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;centerMk.openPopup();</li>
						<li style="background-color:#EFF;">},map);</li>
</strong>
						<li style="background-color:#EEF;"></li>
						</ol></code>
					</div>
					<hr id="e07">
					<div>
						<h3>LayerGroup & FeatureGroup</h3>
<p>						
						L.LayerGroupとL.FeatureGroupはその名の通り複数のレイヤーオブジェクトをグループ化してまとめて扱うためものです。
						両者の違いは、L.LayerGroupからはイベントが発生しないという事です。
</p>
						<p>2つある地底人マーカーをL.LayerGroupeにまとめてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>
						<li style="background-color:#EFF;">var myGroup = L.layerGroup();</li>
</strong>
						<li style="background-color:#EEF;">var points =[</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(35.902538923668644,139.93895530700684),</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;L.latLng(34.707178025105534,135.49422919750214)</li>
						<li style="background-color:#EFF;">];</li>
						<li style="background-color:#EEF;">(function(){</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">(省略)</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;for (var i=0; i &lt; points.length; i++){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.marker(points[i],{icon:myIcon}).addTo(<strong>myGroup</strong>)</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"mouseover"</font>,function(e){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.target.setIcon(myOnIcon);          </li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"mouseout"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.target.setIcon(myIcon);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});            </li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">})();</li>
						</ol></code>

<p>
						おや、地底人が表示されなくなってしまいました。<br>
						これはグループ化の効果をみていただくため、わざと不完全なコードにしていたからです。<br>
</p>

						<p>何が足りなかったか、もうお分かりですね。</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var myGroup = L.layerGroup()<strong>.addTo(map)</strong>;</li>
						</ol></code>

						<p>これで、地底人たちを一つのグループとしてまとめてマップ追加できました。</p>

						<p>さて、先ほど説明しました通りL.LayerGroupではイベントを扱えないので、下記のようなコードはエラーになります。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var myGroup = L.layerGroup().addTo(map).on(<font style="color:brown;">"click"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;<font style="color:green;font-style:italic;">// do something...</font></li>
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>L.LayerGroupをL.FeatureGroupに置き換えて、このグループをクリックしたときにすべての地底人マーカーがビューに収まるような処理を描いてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var myGroup = <strong>L.featureGroup()</strong>.addTo(map)<strong>.on(<font style="color:brown;">"click"</font>,function(e){</strong></li>
<strong>							
						<li style="background-color:#EEF;">&nbsp;&nbsp;map.fitBounds(this.getBounds());</li>
						<li style="background-color:#EFF;">});</li>
</strong>						
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>動作を確かめてください。どうでしょうか。遠く大阪と千葉に離ればなれに存在している地底人が、ビューの中に収まっていますね。</p>

						<p>L.FeatureGroupオブジェクトの個々の要素を参照・操作するには、下のコードのようにeachLayerメソッドでイテレートします。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var myGroup = L.featureGroup().addTo(map).on(<font style="color:brown;">"click"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;map.fitBounds(this.getBounds());</li>
<strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;var i=0;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;this.eachLayer(function(layer){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layer.setIcon(L.icon({iconUrl:<font style="color:brown;">"./images/molamola1.gif"</font>}));</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;});</li>
</strong>						
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>このコードでは、グループがクリックされたときに、グループに属するすべての地底人マーカーをアイコンを別のアイコンにかえています。</p>

						<p>最後に、FeatureGroupについて2点補足します。</p>
<ol>						
						<li>FeatureGroupで発生するイベントは、じつはFeatureGroupに属する個々のオブジェクトから伝搬したものです。<br>従って、clickableオプションがfalseになっているオブジェクトをクリックしても、FeatureGroupは"click"イベントを発生しません。<br><br></li>

												<li>L.MultiPolylineとL.MultiPolygonはFeatureGroupを拡張の拡張クラスで、その内部では、L.FeatureGroupが複数のL.Polyline／L.PolygonのオブジェクトをaddLayer()しています。<br><br></li>
						</ol>
						<p>L.FeatrueGroupとL.LayerGroupの実習は以上です。</p>
					</div>
					<hr id="e08">
					<div>
						<h3>GeoJSON</h3>
						<p>Leafletでは、L.GeoJsonによって、ほとんどコーディングせずにGeoJSONを表示することができます。<br>./js/geojsondata.js にデータを定義してありますので、リンクを張って下さい。</p>
						
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">&lt;script src=<font style="color:brown;">"./js/leaflet/leaflet.js"</font> type=<font style="color:brown;">"text/javascript"</font> charset=<font style="color:brown;">"utf-8"</font>&gt;&lt;/script&gt;</li>
<strong>
						<li style="background-color:#EEF;">&lt;script src=<font style="color:brown;">"./js/geojsondata.js"</font> type=<font style="color:brown;">"text/javascript"</font> charset=<font style="color:brown;">"utf-8"</font>&gt;&lt;/script&gt;</li>
</strong>
						<li style="background-color:#EFF;">&lt;link rel=<font style="color:brown;">"stylesheet"</font> href=<font style="color:brown;">"./js/leaflet/leaflet.css"</font> /&gt;</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>						
							
							<p>下記のコードをタイプして、ブラウザで確認してみましょう。<p>
							<span class="text-warning">大きなデータなので、読み込みに少し時間がかかるかもしれません。</span>
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 行政区域データ（H25）</font></li>
						<li style="background-color:#EFF;">L.geoJson(data).addTo(map);</li>
						</ol></code>
						<p>
						もちろん、少々の手間をかければ、スタイルやインタラクションの設定ができます。<br>
						まず、スタイルを設定してみましょう。
						</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>
						<li style="background-color:#EFF;">var pgnStyle = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#ff8c00"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;weight:1,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#556b2f"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[5, 5],</li>
						<li style="background-color:#EFF;">};</li>
</strong>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 行政区域データ（H25）</font></li>						
						<li style="background-color:#EEF;">L.geoJson(data,<strong>{style:pgnStyle}</strong>).addTo(map);</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

<p>
						GeoJSONのFeatureCollectionの各要素(Feature)にアクセスするには、onEachFeatureを使います。<br>
						ここで生成されるLeafletのオーバーレイオブジェクトにイベントとリスナーファンクションを設定できます。
</p>

<code>
<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<li style="background-color:#EFF;">var pgnStyle = {</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#ff8c00"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;weight:1,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#556b2f"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[5, 5],</li>
<li style="background-color:#EFF;">};</li>
<li style="background-color:#EEF;"></li>
<strong>
<li style="background-color:#EFF;">var pgnOnStyle = {</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#ff0000"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;weight:2,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;fill:true,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;fillColor:<font style="color:brown;">"#ffff2f"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;fillOpacity:0.8,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;dashArray:[20, 10],</li>
<li style="background-color:#EFF;">};</li>
</strong>
<li style="background-color:#EEF;"></li>
<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 行政区域データ（H25）</font></li>
<li style="background-color:#EEF;">L.geoJson(data,{</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;style:pgnStyle,</li>
<strong>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;onEachFeature:function(feature,layer){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addCommonListenersToVector(layer,{offStyle:pgnStyle,onStyle:pgnOnStyle});</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>
<li style="background-color:#EFF;">}).addTo(map);</li>
</ol></code>

<p>
						GeoJSONデータのうち、ある条件に合致する一部のデータだけを表示したい、という場合があるかと思います。<br>
						L.GeoJsonにはそのためのオプションが用意されています。<br>
						他のデータで試してみましょう。
</p>
<code>
<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 河川データ（H21）</font></li>
<li style="background-color:#EEF;">L.geoJson(riversData,{</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;style:{</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#00fa9a"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;weight:3</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;}</li>
<li style="background-color:#EEF;">}).addTo(map);      </li>
<li style="background-color:#EFF;"></li>
</ol></code>
						<p>
						これは、兵庫県の河川データですが、いま欲しいのは表示したいのは1級河川だけだとします。<br>
						スキーマの説明を読むと、W05_003というプロパティに、河川の等級が下記様式で記述されているとあります。
						</p>

<code>
<ul>
						<li>1：1級直轄区間、</li>
						<li>2：1級指定区間、</li>
						<li>3：2級河川区間、</li>
						<li>4：指定区間外、</li>
						<li>5：1級直轄区間でかつ湖沼区間を兼ねる場合、</li>
						<li>6：1級指定区間でかつ湖沼区間を兼ねる場合、</li>
						<li>7：2級河川区間でかつ湖沼区間を兼ねる場合、</li>
						<li>8：指定区間外でかつ湖沼区間を兼ねる場合、</li>
						<li>0：不明</li>
</ul>
</code>			
<p>
						これをもとに、地図に載せるデータを絞り込んでみましょう。<br>
						これには、filterというオプションを使います。
</p>

<code>
<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 河川データ（H21）</font></li>
<li style="background-color:#EFF;">L.geoJson(riversData,{</li>
<strong>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;filter:function(feature,layer){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var rtn;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(feature.properties.W05_003){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"1"</font>:</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"2"</font>:</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"5"</font>:</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"6"</font>:</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtn = true;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtn = false;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return rtn;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
</strong>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;style:{</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#00fa9a"</font>,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:3</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EFF;">}).addTo(map);</li>
<li style="background-color:#EEF;"></li>
</ol></code>
						
						<p>ブラウザで確かめてみましょう。絞り込めているでしょうか。</p>
						
					</div>
					<hr id="e09">
					<div>
						<h3>Control</h3>

						<p>
						Leafletの地図上に表示するオブジェクトには、大きく分けて2つの種類があります。<br>
						ひとつは、これまでに使い方を実習してきたLayerオブジェクトす。もう一つがこれから扱うControlオブジェクトです。<br>
						Layerオブジェクトには位置情報がありますが、Controlオブジェクトにはありません。<br>
						</p>
						<h4>
							定義済みのコントロール
						</h4>
						<p>
						実はここまでの実習で、すでに皆さんは代表的なControlオブジェクトをみています。<br>
						デフォルトで左上に表示されるズームボタンと、右下に表示されるライセンス情報欄です。これらはそれぞれ、L.Control.Zoom,L.Control.Attributionという<br>
						L.Controlクラスのサブクラスです。
						</p>
						<p>コントロールは他にもあります。スケールを表現するL.Control.Scaleのオブジェクトを地図に追加してみましょう。コードのを追加先は、最後の方で結構です。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EEF;"></li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;map.addControl(L.control.scale());</li>
</strong>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/script&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;body&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div id=<font style="color:brown;">"map"</font>&gt;&lt;/div&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/body&gt;</li>
						<li style="background-color:#EFF;">&lt;/html&gt;</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>
							
						<p>確認してみましょう。左下に縮尺が表示されていますね。マイル／フィートのスケールを表示したくない場合は、imperialオプションをfalseにします。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">map.addControl(L.control.scale(<strong>{imperial:false}</strong>));</li>
						</ol></code>

<p>
						もう一つ定義済みのコントロールも使ってみましょう。<br>
						レイヤーの表示／非表示を切り替える、レイヤーコントロール(L.Control.Layers)を地図に追加します。<br>
						前に作成したGeoJSONと、現在使用中のベースのタイルレイヤ、新規のタイルレイヤーをレイヤーコントロールに登録して行きます。<br>
						GeoJsonはそのまま使えないので、L.LayerGroupオブジェクトに格納します。
</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
							<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 行政区域データ（H25）</font></li>
<strong>							
							<li style="background-color:#EEF;">var cities = L.layerGroup();</li>
</strong>
							<li style="background-color:#EFF;">L.geoJson(citiesData,{style:pgnStyle,</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;onEachFeature:function(feature,layer){</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addCommonListenersToVector(layer,{offStyle:pgnStyle,onStyle:pgnOnStyle});</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
							<li style="background-color:#EFF;">}).addTo(<strong>cities</strong>);</li>
							<li style="background-color:#EEF;"></li>
							<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 河川データ（H21）</font></li>
<strong>
							<li style="background-color:#EEF;">var rivers = L.layerGroup();</li>
</strong>
							<li style="background-color:#EFF;">L.geoJson(riversData,{</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;filter:function(feature,layer){</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var rtn;</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(feature.properties.W05_003){</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"1"</font>:</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"2"</font>:</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"5"</font>:</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"6"</font>:</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtn = true;</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rtn = false;</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return rtn;</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;style:{</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:<font style="color:brown;">"#00fa9a"</font>,</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opacity:1,</li>
							<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight:3</li>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
							<li style="background-color:#EEF;">}).addTo(<strong>rivers</strong>);</li>

						<li style="background-color:#EFF;"></li>
<strong>						
						<li style="background-color:#EEF;">var base2 = L.tileLayer(<font style="color:brown;">'http://{s}.tiles.mapbox.com/v3/monomoti.map-40nd7r4j/{z}/{x}/{y}.png'</font>,</li>
						<li style="background-color:#EFF;">{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;attribution:<font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, '</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+<font style="color:brown;">'Design &amp;copy;MapBox '</font></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <font style="color:brown;">'Imagery &amp;copy; DigitalGlobe'</font></li>
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">var baseLayers = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"CloudMade"</font>: baseLayer,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"MapBox"</font>: base2</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">var overlays = {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"国土数値情報 行政区域"</font>: cities,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"国土数値情報 河川"</font>: rivers</li>
						<li style="background-color:#EFF;">};</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">L.control.layers(baseLayers,overlays,{collapsed:true}).addTo(map);</li>
</strong>
						<li style="background-color:#EEF;"></li>
						</ol></code>
<p>
						ブラウザで動作を確認してみましょう。地図の右上にレイヤーコントロールが表示されていますね。<br>
						変数baseLayersに指定したレイヤーはラジオボタンによって常にどちらか一つだけが表示され、変数overlaysのレイヤーはチェックボックスで任意に表示／非表示が切り替えられています。
</p>

						<h4>
							カスタムコントロール
						</h4>
						<p>L.Controlクラスを使って、独自のコントロールを作成することができます。</p>
<p>
						マウスオーバーした行政区域のデータを表示するコントロールを実装してみましょう。<br>
						コントロールのDom要素は、onAddメソッドで作成します。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">

						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 国土数値情報 行政区域データ（H25）</font></li>
						<li style="background-color:#EEF;">var cities = L.layerGroup();</li>
						<li style="background-color:#EFF;">L.geoJson(citiesData,{style:pgnStyle,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;onEachFeature:function(feature,layer){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addCommonListenersToVector(layer,{offStyle:pgnStyle,onStyle:pgnOnStyle});</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layer.on(<font style="color:brown;">"mouseover"</font>,function(e){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(infoControl.el).find(<font style="color:brown;">"#name"</font>).text(feature.properties.N03_004);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(infoControl.el).find(<font style="color:brown;">"#code"</font>).text(feature.properties.N03_007);                            </li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.on(<font style="color:brown;">"mouseout"</font>,function(e){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(infoControl.el).find(<font style="color:brown;">"#name"</font>).text(<font style="color:brown;">""</font>);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(infoControl.el).find(<font style="color:brown;">"#code"</font>).text(<font style="color:brown;">""</font>);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</li>
</strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">}).addTo(cities);</li>

						<li style="background-color:#EEF;"></li>
<strong>						
						<li style="background-color:#EFF;">var infoControl = L.control({position:<font style="color:brown;">"topright"</font>});</li>
						<li style="background-color:#EEF;">infoControl.onAdd = function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;this.el = L.DomUtil.create(<font style="color:brown;">'div'</font>, <font style="color:brown;">'info'</font>);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;$(this.el).html(<font style="color:brown;">"&lt;table&gt;&lt;tr&gt;&lt;th&gt;名称&lt;/th&gt;&lt;td id=\"name\"&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;市町村コード&lt;/th&gt;&lt;td id=\"code\"&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;"</font>)</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;return this.el;</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;">infoControl.addTo(map);</li>
</strong>
						<li style="background-color:#EEF;"></li>
						</ol></code>


						<p>スタイルシートに下記を追加して、コントロールの見た目を整えましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">body{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;margin:0;</li>
						<li style="background-color:#EFF;">}</li>
						<li style="background-color:#EEF;">.my-div-icon{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;color:yellow;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;background-color:green;</li>
						<li style="background-color:#EFF;">}</li>
<strong>						
						<li style="background-color:#EEF;">.info{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;background-color:#fff;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;margin:5px;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;width:150px;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;height:50px;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;overflow:auto;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;border: 2px #A9A9A9 solid;                </li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;border-radius: 7px;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;-webkit-border-radius: 7px;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;-moz-border-radius: 7px;</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">}</li>
						<li style="background-color:#EEF;">.info table th{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;color:orange;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;text-align:right;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;background-color:grey;</li>
						<li style="background-color:#EEF;">}</li>
</strong>						
						<li style="background-color:#EFF;"></li>
						</ol></code>
						
						<p>行政区域のレイヤを表示して、マウスを当ててみてください。右上に新しく追加したinfoControlに名前と市町村コードが表示されていますね。</p>
<p>
						さて、ここで一つTipsがあります。<br>
						いまのコードだと、infoControlでクリック、マウスダウン、ダブルクリックを行うと、そのイベントが下の地図に伝搬してしまいます。<br>
						例えば、infoControlの上でマウスをドラッグすると、地図がスクロールしてしまいます。
</p>
						<p>これを回避するためには、infoControlのonAddメソッドを下のように修正します。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var infoControl = L.control({position:<font style="color:brown;">"topright"</font>});</li>
						<li style="background-color:#EEF;">infoControl.onAdd = function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;this.el = L.DomUtil.create(<font style="color:brown;">'div'</font>, <font style="color:brown;">'info'</font>);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;$(this.el).html(<font style="color:brown;">"&lt;table&gt;&lt;tr&gt;&lt;th&gt;名称&lt;/th&gt;&lt;td id=\"name\"&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;市町村コード&lt;/th&gt;&lt;td id=\"code\"&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;"</font>);</li>
						<li style="background-color:#EEF;"	></li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;L.DomEvent.on(this.el,<font style="color:brown;">"click"</font>,L.DomEvent.stopPropagation);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;L.DomEvent.on(this.el,<font style="color:brown;">"mousedown"</font>,L.DomEvent.stopPropagation);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;L.DomEvent.on(this.el,<font style="color:brown;">"dblclick"</font>,L.DomEvent.stopPropagation);</li>
</strong>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;return this.el;</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;">infoControl.addTo(map);</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>


						<p>イベントの伝搬を止めたいというケースは良くあるので、この方法を覚えておくとよいでしょう。</p>

						<p>これでセッションの前半は終わりです。おつかれさまでした！</p>
						<p class="text-info">
						  ここまでの成果と同じものが、<a target="_blank"  href="../basics/results/r09.html"><code>こちら (＜教材をコピーしたフォルダ＞/basics/results/r09.html)</code></a> にあります。上手く行かないところがある場合は、自分のコードと比べてみてください。
						</p>

						<p>次はいよいよ、 Backbone.js + Leafletの実習です。</p>
						
					</div>

          <hr id="app-intro">
					<div>
						<h2>
							実践Backbone.js + Leaflet
						</h2>
<p>						
						さて、いよいよ本番です。<br>
						ここからは、前半で学んだ事をもとにして、web地図アプリを作っていきます。<br>
						実際のwebアプリ開発では、一つのライブラリだけしか使わないという事は稀で、たいていは複数のものを組み合わせて使うことになります。<br>
						このセッションでは、下記のライブラリを組み合わせてwebアプリを作成します。<br>
</p>
<ul>
						<li>Backbone.js <br>
							<small>jQuery, undercore.jsに依存しています。</small>
						</li>
						<li>Require.js</li>
						<li>Leaflet</li>
						<li>Leaflet Draw Plugin (<a href="https://github.com/Leaflet/Leaflet.draw">https://github.com/Leaflet/Leaflet.draw</a>)<br>
						</li>
</ul>
<p>
						Backbone.jsは近年最も使われているJavaScriptのアプリケーションフレームワーク1つです。<br>
						コードをMVC(Model, View, Controler)に分けて記述するので、処理の流れが追いやすく、メンテナンスを容易にできます。<br>
						Require.jsは、複数のJavaScriptファイル（モジュールと呼びます）からなるアプリケーションを、依存関係を処理しながら構築するためのJavaScriptライブラリです。<br>
						Leaflet Draw Pluginは、マウスの操作で地図上にオーバーレイを描くためのLeafletのプラグインです。<br>
</p>
						<p>サーバーサイドでは下記（筆者環境）を使用しますが、今日皆さんがコードに手を付ける事は、固定値の設定以外にはありません。</p>
<ul>
						<li>Python v2.7.5</li>
						<li>Django v1.5.4</li>
</ul>

            <p class="text-info">
              Djangoが動作する環境がない方も、<a target="_blank" href="../client_only/index.html"><code>こちら</code></a> 
              で、サーバーにデータを保存する以外の動作が確認できます(Safari, FireFoxではファイルシステムでも動作。Chromeではwebサーバに配置する必要があります。)。
            </p>


						<p>セッションに移る前に、下記を行ってください。</p>
						
						<ol>
							<li>
								＜教材をコピーしたフォルダ＞/application/thesite/thesite/settings.pyの「STATIC_ROOT」で始まる行を、下記のように設定します。<br><br>
								<code>
									STATIC_ROOT = '＜教材をコピーしたフォルダ＞/application/server/static/'
								</code>
								<br><br>
							</li>
							<li>
								ターミナルで下記を実行します。<br><br>
								<code>
									cd ＜教材をコピーしたフォルダ＞/application/thesite<br>
									python manage.py collectstatic --noinput<br>
									python manage.py runserver<br>
								</code>
								<br>
							</li>
						</ol>
						
						<h4>何を作るのか (架空のストーリー)</h4>



<div class="well">
<em>	
						<p>避難対象地域、一時避難所、避難経路を示す地図サイトが公開されています。（そうは見えないかもしれませんが、そう思ってください）。</p>
						<a href="http://localhost:8000/gjsv" target="_blank"><code>http://localhost:8000/gjsv</code></a><br><br>
						<p>データは同じサーバーにあるGeoJSON形式のファイルをもとにしています。</p>
						<p>あなたのチームは、ブラウザ上でこのGeoJSONを編集・更新するアプリケーションを作っています。</p>
						<p>すでにあなたの同僚が一時避難所のデータを編集・更新する機能を実装しました。</p>

						<a href="http://localhost:8000/gjsv/editor" target="_blank"><code>http://localhost:8000/gjsv/editor</code></a>
<br><br>
						<p>しかし、肝心の位置情報を入力する機能がありません。</p>
						<p>それがあなたの担当です。</p>
						<p>あなたはこの位置情報の入力ツールとして、Leafletを使う事に決めました...</p>
</em>
</div>												
					</div>
					<hr id="a01">
					<div>
						<h3>Step01</h3>
<p>
						ファイルブラウザで、下記ディレクトリを開いて下さい。
						編集すべきファイルはすべてここにあります。
</p>
						<code>＜教材をコピーしたフォルダ＞/application/thesite/gjsv/static/js</code><br><br>
<p>
						現状を確認しましょう。<br>
						まず、アプリケーションの開始地点は、app.jsにあります。
</p>

<code>
<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<li style="background-color:#EFF;">(function(){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;requirejs.config({</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;baseUrl: <font style="color:brown;">"/static/js"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paths: {</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"jquery"</font>: <font style="color:brown;">"lib/jquery-1.10.2.min"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"underscore"</font>: <font style="color:brown;">"lib/underscore-min"</font>,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"backbone"</font>: <font style="color:brown;">"lib/backbone-min"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"bootstrap"</font>:<font style="color:brown;">"lib/bootstrap.min"</font>,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;"></li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shim: {</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"jquery"</font>:{</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"jQuery"</font></li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"underscore"</font>: {</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"_"</font></li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"backbone"</font>: {</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deps: [<font style="color:brown;">"jquery"</font>, <font style="color:brown;">"underscore"</font>],</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"Backbone"</font></li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"bootstrap"</font>:{</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deps:[<font style="color:brown;">"jquery"</font>],</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"bootstrap"</font></li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;urlArgs: <font style="color:brown;">"bust="</font> +  (new Date()).getTime()</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;require([<font style="color:brown;">"jquery"</font>,<font style="color:brown;">"underscore"</font>,<font style="color:brown;">"backbone"</font>,<font style="color:brown;">"models"</font>, <font style="color:brown;">"views"</font>], function($,_,Backbone,models, views){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var appView = new views.ApplicationView();</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">})();</li>
<li style="background-color:#EEF;"></li>
</ol></code>

<p>このファイルでは、前半の</p>

						<code>
						<ul style="list-style:none outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">requirejs.config( ...);</li>
						</ul></code>

						<p>で依存関係を処理し、下の方にあるこの行</p>

						<code>
						<ol style="list-style:none outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var appView = new views.ApplicationView();</li>
						</ol></code>

						<p>でviewsというモジュールのApplicationViewクラスを初期化しています。</p>
<p>
						require.jsでは、特別に設定していない場合、同じ階層に＜モジュール名＞.jsがあるものとして動作します。<br>
						同じ階層のviews.jsを開いてみましょう。
</p>

<code>
<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<li style="background-color:#EFF;">define([<font style="color:brown;">"jquery"</font>,<font style="color:brown;">"underscore"</font>,<font style="color:brown;">"backbone"</font>,<font style="color:brown;">"models"</font>,<font style="color:brown;">"apputil"</font>,<font style="color:brown;">"mapviews"</font>],function($,_,Backbone,models,apputil,mapviews){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;window.app || (window.app = {});</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var app = window.app;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;if (! app.eventBus){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app.eventBus = apputil.EventBus;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var ApplicationView = Backbone.View.extend({</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;el :<font style="color:brown;">"#App"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;events:{</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"click #SaveGJBtn"</font>:<font style="color:brown;">"saveBtnClicked"</font>,</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.pointGJModel = new models.PointGJModel();</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.routeGJModel = new models.RouteGJModel();</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.areaGJModel = new models.AreaGJModel();            </li>
<li style="background-color:#EFF;">&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.placeListView = new PlaceListView({collection:this.pointGJModel.get(<font style="color:brown;">"features"</font>)});</li>
<li style="background-color:#EFF;"></li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.mapView = new mapviews.MapContainerView({</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pointCollection:this.pointGJModel.get(<font style="color:brown;">"features"</font>),</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;routeCollection:this.routeGJModel.get(<font style="color:brown;">"features"</font>),</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;areaCollection:this.areaGJModel.get(<font style="color:brown;">"features"</font>)</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(window).on(<font style="color:brown;">"resize"</font>,function(){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app.eventBus.trigger(app.eventBus.WINDOW_RESIZED,{width:$(window).width(),height:$(window).height()});</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</li>
<li style="background-color:#EEF;"></li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.pointGJModel.fetch({error:this.gJFailed});</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.routeGJModel.fetch({error:this.gJFailed});</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.areaGJModel.fetch({error:this.gJFailed});</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.pointGJModel.on(<font style="color:brown;">"saved"</font>,function(){this.oneSaved(<font style="color:brown;">"point"</font>)},this);</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.routeGJModel.on(<font style="color:brown;">"saved"</font>,function(){this.oneSaved(<font style="color:brown;">"route"</font>)},this);</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.areaGJModel.on(<font style="color:brown;">"saved"</font>,function(){this.oneSaved(<font style="color:brown;">"area"</font>)},this);</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gJFailed:function(model,response,options){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(<font style="color:brown;">"gjFailed "</font> + JSON.stringify(response));</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;saveBtnClicked:function(){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.saving = true;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.pointSaved = false;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.routeSaved = false;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.areaSaved = false;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.pointGJModel.saveAsGeoJSON();  </li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.routeGJModel.saveAsGeoJSON();  </li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.areaGJModel.saveAsGeoJSON();  </li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oneSaved:function(type){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (type == <font style="color:brown;">"point"</font>){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.pointSaved = true;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else if(type == <font style="color:brown;">"route"</font>){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.routeSaved = true;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else if(type == <font style="color:brown;">"area"</font>){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.areaSaved = true;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.pointSaved &amp;&amp; this.routeSaved &amp;&amp; this.areaSaved){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.saving = true;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(<font style="color:brown;">"SAVED!"</font>);</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
<li style="background-color:#EFF;"></li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var PlaceListView = Backbone.View.extend({</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;el:<font style="color:brown;">"#PlaceList"</font>,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"reset"</font>,this.renderList,this);</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"add"</font>,this.addNewRow,this);</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"remove"</font>,this.renderList,this);</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.updateToWindowSize();</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(app.eventBus,app.eventBus.WINDOW_RESIZED,this.updateToWindowSize,this);</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;renderList:function(){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.$(<font style="color:brown;">"tbody"</font>).empty();</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.each(function(m){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.addNewRow(m);</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},this);</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addNewRow:function(m){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var rowView = new PlaceListRowView({model:m});</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.$(<font style="color:brown;">"tbody"</font>).append(rowView.render().el);</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateToWindowSize:function(size){</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!size){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size = {width:$(window).width(),height:$(window).height()};                </li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.$el.parent().css({<font style="color:brown;">"height"</font>:size.height - 150});</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var PlaceListRowView = Backbone.View.extend({</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tagName:<font style="color:brown;">"tr"</font>,</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;events:{</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"change input"</font>:<font style="color:brown;">"edited"</font>,  </li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;template:_.template($(<font style="color:brown;">"#PlaceListRow-template"</font>).html()),</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;render:function(){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.$el.html(this.template(this.model.toJSON()));</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this;</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edited:function(e){</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var $target = $(e.target);</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.model.set($target.data(<font style="color:brown;">"field"</font>),$target.val());</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;return {</li>
<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"ApplicationView"</font>:ApplicationView</li>
<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;}; </li>
<li style="background-color:#EEF;">});</li>
<li style="background-color:#EFF;"></li>
</ol></code>

<p>
						9行目からApplicationViewが定義されていますね。
						その中で、22行目に
</p>
						<code>
						<ol style="list-style:none outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">this.mapView = new mapviews.MapContainerView(...</li>
						</ol></code>

						<p>とあり、mapviewモジュールが呼び出されているのがわかります。mapview.jsを開いてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">define([<font style="color:brown;">"jquery"</font>,<font style="color:brown;">"underscore"</font>,<font style="color:brown;">"backbone"</font>,<font style="color:brown;">"models"</font>,<font style="color:brown;">"apputil"</font>],function($,_,Backbone,models,apputil){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;window.app || (window.app = {});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var app = window.app;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;if (! app.eventBus){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app.eventBus = apputil.EventBus;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var MapContainerView = Backbone.View.extend({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;return {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"MapContainerView"</font>:MapContainerView</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;}; </li>
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>空っぽのMapContainerViewがあるだけです。ここがあなたの担当する箇所です。</p>

						<p>また、htmlファイルに相当するファイルは、下記にあります。</p>

						<code>＜教材をコピーしたフォルダ＞/application/thesite/gjsv/templates/gjsv/editor.html</code>
						<p>23行目に地図を埋め込むdiv要素が用意されています。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">&lt;!DOCTYPE html&gt;</li>
						<li style="background-color:#EEF;">&lt;html lang=<font style="color:brown;">"ja"</font>&gt;</li>
						<li style="background-color:#EFF;">&lt;head&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&lt;meta charset=<font style="color:brown;">"utf-8"</font>&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta http-equiv=<font style="color:brown;">"Pragma"</font> content=<font style="color:brown;">"no-cache"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta http-equiv=<font style="color:brown;">"Cache-Control"</font> content=<font style="color:brown;">"no-cache"</font>&gt;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&lt;title&gt;EDITOR&lt;/title&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&lt;link href=<font style="color:brown;">"/static/css/bootstrap.min.css"</font> rel=<font style="color:brown;">"stylesheet"</font> media=<font style="color:brown;">"screen"</font>&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&lt;link rel=<font style="color:brown;">"stylesheet"</font> href=<font style="color:brown;">"/static/js/lib/leaflet/leaflet.css"</font> /&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;<font style="color:green;font-style:italic;">&lt;!--[if lte IE 8]&gt;&lt;link rel="stylesheet" href="/static/js/lib/leaflet/leaflet.ie.css" /&gt;&lt;![endif]--&gt;</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&lt;link rel=<font style="color:brown;">"stylesheet"</font> href=<font style="color:brown;">"/static/js/lib/leaflet/leaflet.draw.css"</font> /&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:green;font-style:italic;">&lt;!--[if lte IE 8]&gt;&lt;link rel="stylesheet" href="/static/js/lib/leaflet/leaflet.draw.ie.css" /&gt;&lt;![endif]--&gt;</font></li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&lt;link rel=<font style="color:brown;">"stylesheet"</font> href=<font style="color:brown;">"/static/css/app.css"</font> type=<font style="color:brown;">"text/css"</font> media=<font style="color:brown;">"screen"</font> title=<font style="color:brown;">"no title"</font> charset=<font style="color:brown;">"utf-8"</font>&gt;</li>
						<li style="background-color:#EFF;">&lt;/head&gt;</li>
						<li style="background-color:#EEF;">&lt;body id=<font style="color:brown;">"App"</font>&gt;</li>
						<li style="background-color:#EFF;">{% csrf_token %}&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;nav class=<font style="color:brown;">"navbar navbar-default"</font> role=<font style="color:brown;">"navigation"</font>&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button type=<font style="color:brown;">"button"</font> id=<font style="color:brown;">"SaveGJBtn"</font> class=<font style="color:brown;">"btn btn-default btn-sm navbar-btn pull-right"</font>&gt;Save&lt;/button&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/nav&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=<font style="color:brown;">"container"</font> id=<font style="color:brown;">"Main"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=<font style="color:brown;">"row full-width-row"</font>&gt;</li>

<strong>
							<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=<font style="color:brown;">"col-xs-6"</font> id=<font style="color:brown;">"MapContainer"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div id=<font style="color:brown;">"map"</font> class=<font style="color:brown;">"fill"</font>&gt;&lt;/div&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;</li>
</strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=<font style="color:brown;">"col-xs-6"</font>&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=<font style="color:brown;">"panel panel-default"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div class=<font style="color:brown;">"panel-heading"</font>&gt;PLACE LIST&lt;/div&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div id=<font style="color:brown;">"PlaceListContainer"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;table class=<font style="color:brown;">"table"</font> id=<font style="color:brown;">"PlaceList"</font>&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;NAME&lt;/th&gt;&lt;th&gt;CAPACITY&lt;/th&gt;&lt;th&gt;OCCUPIED&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tbody&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tr&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;td&gt;ここにリスト&lt;/td&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tr&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tbody&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/table&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;script type=<font style="color:brown;">"text/template"</font> id=<font style="color:brown;">"PlaceListRow-template"</font>&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;td&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=<font style="color:brown;">"text"</font> class=<font style="color:brown;">"form-control"</font> data-field=<font style="color:brown;">"name"</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value=<font style="color:brown;">"&lt;%- (typeof name != 'undefined' &amp;&amp; name) ? name : '' %&gt;"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/td&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;td&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=<font style="color:brown;">"text"</font> class=<font style="color:brown;">"form-control"</font> data-field=<font style="color:brown;">"capacity"</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value=<font style="color:brown;">"&lt;%- (typeof capacity != 'undefined' &amp;&amp; capacity) ? capacity : 0 %&gt;"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/td&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;td&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=<font style="color:brown;">"text"</font> class=<font style="color:brown;">"form-control"</font> data-field=<font style="color:brown;">"occupied"</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value=<font style="color:brown;">"&lt;%- (typeof occupied != 'undefined' &amp;&amp; occupied) ? occupied : 0 %&gt;"</font>&gt;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/td&gt;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/script&gt;</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;  &lt;script data-main=<font style="color:brown;">"/static/js/app"</font> src=<font style="color:brown;">"/static/js/require.js"</font>&gt;&lt;/script&gt;</li>
						<li style="background-color:#EEF;">&lt;/body&gt;</li>
						<li style="background-color:#EFF;">&lt;/html&gt;</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>


						<p>
						では、開発を始めましょう。<br>
						まず、LeafletとLeaflet Draw Plugin（以降Drawプラグインと呼びます）が使えるように、app.jsに依存関係を追加します。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">(function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;requirejs.config({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;baseUrl: <font style="color:brown;">"/static/js"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;paths: {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"jquery"</font>: <font style="color:brown;">"lib/jquery-1.10.2.min"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"underscore"</font>: <font style="color:brown;">"lib/underscore-min"</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"backbone"</font>: <font style="color:brown;">"lib/backbone-min"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"bootstrap"</font>:<font style="color:brown;">"lib/bootstrap.min"</font>,</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"leaflet"</font>:<font style="color:brown;">"lib/leaflet/leaflet"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"leafletdraw"</font>:<font style="color:brown;">"lib/leaflet/leaflet.draw"</font></li>
</strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shim: {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"jquery"</font>:{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"jQuery"</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"underscore"</font>: {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"_"</font></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"backbone"</font>: {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deps: [<font style="color:brown;">"jquery"</font>, <font style="color:brown;">"underscore"</font>],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"Backbone"</font></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"bootstrap"</font>:{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deps:[<font style="color:brown;">"jquery"</font>],</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports: <font style="color:brown;">"bootstrap"</font></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"leaflet"</font>:{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports:<font style="color:brown;">"L"</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"leafletdraw"</font>:{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deps:[<font style="color:brown;">"leaflet"</font>],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exports:<font style="color:brown;">"leafletdraw"</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}            </li>
</strong>

						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;urlArgs: <font style="color:brown;">"bust="</font> +  (new Date()).getTime()</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;require([<font style="color:brown;">"jquery"</font>,<font style="color:brown;">"underscore"</font>,<font style="color:brown;">"backbone"</font>,<font style="color:brown;">"models"</font>, <font style="color:brown;">"views"</font>], function($,_,Backbone,models, views){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var appView = new views.ApplicationView();</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">})();</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>次に、mapviews.jsから、leafltモジュールとleafletdrawモジュールを参照するようにします。<br>
							ここから先は、mapviews.jsで作業します。
						</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">define([<font style="color:brown;">"jquery"</font>,<font style="color:brown;">"underscore"</font>,<font style="color:brown;">"backbone"</font>,<font style="color:brown;">"models"</font>,<font style="color:brown;">"apputil"</font>,<strong><font style="color:brown;">"leaflet"</font>,<font style="color:brown;">"leafletdraw"</font></strong>],</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;function($,_,Backbone,models,apputil,<strong>L,leafletdraw</strong>){</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>
						
						<p>これで準備完了です。</p>

					</div>
					<hr id="a02">
					<div>
						<h3>Step02</h3>
						<p>地図を表示するコードを書いてみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var MapContainerView = Backbone.View.extend({</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;el:<font style="color:brown;">"#MapContainer"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.map = L.map(<font style="color:brown;">"map"</font>,{minZoom:2,maxZoom:20}).setView([34,135], 8);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var baseTileUrl = <font style="color:brown;">'http://{s}.tile.cloudmade.com/77b7b2219a944c3cbf118035611d6dae/997/256/{z}/{x}/{y}.png'</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attribution = <font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, Imagery &amp;copy; &lt;a href="http://cloudmade.com"&gt;CloudMade&lt;/a&gt;'</font>;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.tileLayer(baseTileUrl,{ attribution: attribution}).addTo(this.map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
</strong>
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

<p>						elに、このViewと結びつけるDOM要素を指定しています。こうしておくと、MapContainerViewの中では、this.elでこのDOM要素に参照できます。<br>また、同じDOM要素のjQueryオブジェクトにはthis.$elで参照できます。
</p>
<p>
						以降もこのようなBackbone.jsやrequire.jsの決まり事に多く出くわしますが、いまは「まあ、そういうものだ」と思って進めていきましょう。<br>
						（勿論、セッション後の質問は大歓迎です！）
</p>
						<p>おっと、地図のコンテナとなるdiv要素には、高さが必要でしたね。前半のセッションでやったように、高さを設定してみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var MapContainerView = Backbone.View.extend({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;el:<font style="color:brown;">"#MapContainer"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.map = L.map(<font style="color:brown;">"map"</font>,{minZoom:2,maxZoom:20}).setView([34,135], 8);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var baseTileUrl = <font style="color:brown;">'http://{s}.tile.cloudmade.com/77b7b2219a944c3cbf118035611d6dae/997/256/{z}/{x}/{y}.png'</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attribution = <font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, Imagery &amp;copy; &lt;a href="http://cloudmade.com"&gt;CloudMade&lt;/a&gt;'</font>;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.tileLayer(baseTileUrl,{ attribution: attribution}).addTo(this.map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.updateToWindowSize();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(app.eventBus,app.eventBus.WINDOW_RESIZED,this.updateToWindowSize,this);</li>
</strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;updateToWindowSize:function(size){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!size){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size = {width:$(window).width(),height:$(window).height()};                </li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.$el.height(size.height - 100);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.map){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.map.invalidateSize();                </li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
</strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">});</li>
						</ol></code>

						<p>ブラウザで確認してみてください。地図が表示されていますね。</p>										
					</div>
					<hr id="a03">
					<div>
						<h3>Step03</h3>
						
						<p>次は、一時避難所に関する処理をするViewを作ります。<br>
						このあと、避難経路と避難対象区域の実装があるので、同じ事を繰り返す無駄のないよう、極力処理を共通化する事を念頭に置きます。
						</p>
<p>
						一時避難所のデータは、既に同僚がGeoJSONをパースして、MapContainerViewのコンストラクタにpointCollectionというキーのオプションに渡してくれています。<br>
						pointCollectionは、GeoJSONの各Featureのデータを格納する複数のModelをひとまとめに扱う、コレクションという配列のようなオブジェクトです。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// views.js のApplicationView内</font></li>
						<li style="background-color:#EEF;">this.mapView = new mapviews.MapContainerView({</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;pointCollection:this.pointGJModel.get(<font style="color:brown;">"features"</font>),</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;routeCollection:this.routeGJModel.get(<font style="color:brown;">"features"</font>),</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;areaCollection:this.areaGJModel.get(<font style="color:brown;">"features"</font>)</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;});</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>お察しの通り、避難経路のデータはrouteCollection、避難対象区域のデータはareaCollectionというキーで渡されています。</p>


						<p>一時避難所を表示するところまでやってみましょう。</p>
<p>
						まず先に、pointCollection、routeCollection、areaCollectionを処理するViewで共通する部分を作っておきます。<br>
						以降、特に断りがない場合は、コードの末尾（"MapContainerView":MapContainerView}の手前）に追記してください。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var LayerMixin = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer = new L.FeatureGroup();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"reset"</font>,this.renderLayer,this);        </li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;renderLayer:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer.clearLayers();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.each(function(m){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.addNewLayer(m);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},this);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;addNewLayer:function(m){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var modelView = new (this.getFeatureViewClass())({model:m});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modelView.layer.addTo(this.layer);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

<p>
						前半で実習したL.FeatureGroupが出てきましたね。まだ動きを見られないので解説は後にして、先に進みます。<br>
						続いて、pointCollection、routeCollection、areaCollectionの各モデル(GeoJSONの各Featureに相当します)を処理するViewに共通する処理を作ります。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var FeatureMixin = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.renderLayer();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;renderLayer:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer = new (this.getFeatureClass())(this.model.get(<font style="color:brown;">"coordinates"</font>),this.featureOption);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>pointCollectionと、その各Modelを処理するViewを定義します。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 一時避難所データの集合(pointCollection)を扱うView</font></li>
						<li style="background-color:#EEF;">var PointLayerView = Backbone.View.extend(_.extend({},LayerMixin,{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureViewClass:function(){return PointView},</li>
						<li style="background-color:#EEF;">}));</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;"><font style="color:green;font-style:italic;">// 一時避難所データ(pointCollectionのModel)を扱うView</font></li>
						<li style="background-color:#EFF;">var PointView = Backbone.View.extend(_.extend({},FeatureMixin,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureClass:function(){return L.Marker},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;featureOption: null,</li>
						<li style="background-color:#EEF;">}));</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>MapContainerViewからPointLayerViewを呼び出して、一時避難所を地図上に表示します。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>
						<li style="background-color:#EFF;">initialize:function(options){</li>
</strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;this.map = L.map(<font style="color:brown;">"map"</font>,{minZoom:2,maxZoom:20}).setView([34,135], 8);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var baseTileUrl = <font style="color:brown;">'http://{s}.tile.cloudmade.com/77b7b2219a944c3cbf118035611d6dae/997/256/{z}/{x}/{y}.png'</font>,</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;attribution = <font style="color:brown;">'Map data &amp;copy; &lt;a href="http://osm.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors, Imagery &amp;copy; &lt;a href="http://cloudmade.com"&gt;CloudMade&lt;/a&gt;'</font>;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;L.tileLayer(baseTileUrl,{ attribution: attribution}).addTo(this.map);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;this.updateToWindowSize();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(app.eventBus,app.eventBus.WINDOW_RESIZED,this.updateToWindowSize,this);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;this.pointLayerView = new PointLayerView({collection:options.pointCollection});</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;this.pointLayerView.layer.addTo(this.map);    </li>
</strong>
						<li style="background-color:#EEF;">},</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>処理の流れを解説します。このような流れになっています。</p>
<ol>
						<li>MapContainerViewのinitializeメソッドから、PointLayerViewを呼び出す。<br><br></li>
						<li> PointLayerViewは、LayerMixinに定義されているinitializeメソッドを実行。このときPointLayerViewのlayerプロパティにL.FeatureGroupのオブジェクトが割り当てられる。<br><br></li>
						<li>また、pointCollectionのresetイベント（GeoJSONのパース完了がトリガとなる）の監視を開始し、リスナーファンクションにrenderLayerを割り当てて、マーカーをlayerプロパティに追加するようにする。<br><br></li>
						<li>MapContainerViewのmapプロパティがPointLayerViewのlayerプロパティをaddLayerする。<br><br></li>
						<li>pointCollectionのresetイベントが発生し、マーカーが地図上に表示される。<br><br></li>
</ol>
						<p>避難経路と避難対象区域にについても、対応するViewを作ってみましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 避難経路データの集合(routeCollection)を扱うView</font></li>
						<li style="background-color:#EEF;">var PolylineLayerView = Backbone.View.extend(_.extend({},LayerMixin,{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureViewClass:function(){return PolylineView},</li>
						<li style="background-color:#EEF;">}));</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;"><font style="color:green;font-style:italic;">// 避難経路データ(routeCollectionのModel)を扱うView</font></li>
						<li style="background-color:#EFF;">var PolylineView = Backbone.View.extend(_.extend({},FeatureMixin,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureClass:function(){return L.Polyline},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;featureOption: {opacity:1},        </li>
						<li style="background-color:#EEF;">}));</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;"><font style="color:green;font-style:italic;">// 避難対象区域データの集合(areaCollection)を扱うView</font></li>
						<li style="background-color:#EFF;">var PolygonLayerView = Backbone.View.extend(_.extend({},LayerMixin,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureViewClass : function(){return PolygonView},</li>
						<li style="background-color:#EFF;">}));</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 避難対象区域データ(areaCollectionのModel)を扱うView </font></li>
						<li style="background-color:#EEF;">var PolygonView = Backbone.View.extend(_.extend({},FeatureMixin,{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureClass:function(){return L.Polygon},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;featureOption:{color:<font style="color:brown;">"#f00"</font>,fillColor:<font style="color:brown;">"#f00"</font>,fillOpacity:0.8},</li>
						<li style="background-color:#EFF;">}));</li>
						</ol></code>


						<p>MapContainerViewのinitializeにPolylineLayerViewとPolygonLayerViewを呼び出して、layerプロパティを地図に追加します。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">this.pointLayerView = new PointLayerView({collection:options.pointCollection});</li>
						<li style="background-color:#EEF;">this.pointLayerView.layer.addTo(this.map);</li>
<strong>
						<li style="background-color:#EFF;">this.routeLayerView = new PolylineLayerView({collection:options.routeCollection});</li>
						<li style="background-color:#EEF;">this.routeLayerView.layer.addTo(this.map);</li>
						<li style="background-color:#EFF;">this.areaLayerView = new PolygonLayerView({collection:options.areaCollection});</li>
						<li style="background-color:#EEF;">this.areaLayerView.layer.addTo(this.map); </li>
</strong>
						<li style="background-color:#EFF;"></li>
						</ol></code>

						<p>ブラウザで確認してみましょう。新たに避難経路と避難対象区域が表示されましたね。</p>

					</div>
					<hr id="a04">
					<div>
						<h3>Step04</h3>
						
						<p>次は、位置情報の入力・編集機能を呼び出す為の、カスタムコントロールのViewを作成します。</p>

						<p>少し長いですが、がんばってこのコードを入力してください。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var EditControlView = Backbone.View.extend({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(options){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.items = options.items;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var that = this;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var editControl = L.Control.extend({</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options: {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position: <font style="color:brown;">'topright'</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onAdd: function (map) {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var container = L.DomUtil.create(<font style="color:brown;">'div'</font>, <font style="color:brown;">' leaflet-bar'</font>);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_.each(that.items,function(i){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i.view = new EditControlItemView({type:i.type,text:i.text,containerView:this});</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(container).append(i.view.render().el);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(i.view,<font style="color:brown;">"itemClicked"</font>,this.itemClicked,this);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},that);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return container;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.control = new editControl();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;itemClicked:function(type){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.activeType === type){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type = <font style="color:brown;">""</font>;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_.each(this.items,function(i){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (type != i.type &amp;&amp; i.view.$el.hasClass(<font style="color:brown;">"active"</font>)){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i.view.$el.removeClass(<font style="color:brown;">"active"</font>);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},this);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.activeType = type;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.trigger(<font style="color:brown;">"toggleEdit"</font>,type);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">});</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">var EditControlItemView = Backbone.View.extend({</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;tagName:<font style="color:brown;">"button"</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;events:{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:brown;">"click"</font>:<font style="color:brown;">"fireClicked"</font></li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(options){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.type = options.type;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.containerView = options.containerView;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.text = options.text;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;render:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.$el.text(this.text).addClass(<font style="color:brown;">"btn btn-xs btn-primary"</font>).attr(<font style="color:brown;">"type"</font>,<font style="color:brown;">"button"</font>);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.DomEvent.on(this.el,<font style="color:brown;">"click"</font>,L.DomEvent.stopPropagation);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.DomEvent.on(this.el,<font style="color:brown;">"mousedown"</font>,L.DomEvent.stopPropagation);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.DomEvent.on(this.el,<font style="color:brown;">"dblclick"</font>,L.DomEvent.stopPropagation);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;fireClicked:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.$el.toggleClass(<font style="color:brown;">"active"</font>).blur();</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.trigger(<font style="color:brown;">"itemClicked"</font>,this.type);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">});</li>
						</ol></code>
<p>
						作成したEditControlViewをMapContainerViewのinitializeから呼び出して、地図に追加します。<br>
						下記のコードを、PointLayerViewの呼び出しより前に挿入してください。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">this.editControlView = new EditControlView({items:[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;{type:<font style="color:brown;">"place"</font>,text:<font style="color:brown;">"edit places"</font>},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;{type:<font style="color:brown;">"route"</font>,text:<font style="color:brown;">"edit routes"</font>},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;{type:<font style="color:brown;">"area"</font>,text:<font style="color:brown;">"edit areas"</font>},</li>
						<li style="background-color:#EFF;">]});</li>
						<li style="background-color:#EEF;">L.drawLocal.edit.toolbar.actions.save.text = <font style="color:brown;">"OK"</font>;</li>
						<li style="background-color:#EFF;">this.map.addControl(this.editControlView.control);</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>
<p>
						ブラウザで確認してみましょう。地図の右上に、3つのボタンからなるカスタムコントロールが表示されていますね。<br>
						しかしまだこのカスタムコントロールは完全ではありません。<br>
						いずれかのボタンがクリックされたときに、クリックしたボタンに適したDrawプラグインのツールコントロールを呼び出す必要があります。<br>
						一時避難所ならマーカー、避難経路ならポリライン、避難対象区域ならポリゴンを入力するツールを表示すべきでしょう。
</p>
<p>
						EditControlViewは、ボタンがクリックされたときに、"toggleEdit"というイベントを、クリックされたボタンの識別子イベントオブジェクトとしてトリガーするようになっているので、
						これをMapContainerViewで監視するようにします。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">this.editControlView = new EditControlView({items:[</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;{type:<font style="color:brown;">"place"</font>,text:<font style="color:brown;">"edit places"</font>},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;{type:<font style="color:brown;">"route"</font>,text:<font style="color:brown;">"edit routes"</font>},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;{type:<font style="color:brown;">"area"</font>,text:<font style="color:brown;">"edit areas"</font>},</li>
						<li style="background-color:#EFF;">]});</li>
						<li style="background-color:#EEF;">L.drawLocal.edit.toolbar.actions.save.text = <font style="color:brown;">"OK"</font>;</li>
						<li style="background-color:#EFF;">this.map.addControl(this.editControlView.control);</li>
<strong>						
						<li style="background-color:#EEF;">this.listenTo(this.editControlView,<font style="color:brown;">"toggleEdit"</font>,this.toggleEdit,this);</li>
</strong>
						<li style="background-color:#EFF;"></li>
						</ol></code>
<p>
						リスナーファンクションのtoggleEditを、MapContainerViewに定義します。<br>
						updateToWindowSizeの下に入れてみましょう。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">toggleEdit:function(type){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;if (this.activeEditControl){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.map.removeControl(this.activeEditControl);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete this.activeEditControl;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;var options = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;position:<font style="color:brown;">'topright'</font>,</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;draw:{polyline:null,polygon:null,rectangle:null,circle:null,marker:null},</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edit:{remove: true}</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;};</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;switch(type){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"place"</font>:</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.draw.marker = true;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.edit.featureGroup = this.pointLayerView.layer;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"route"</font>:</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.draw.polyline = true;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.edit.featureGroup = this.routeLayerView.layer;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"area"</font>:</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.draw.polygon = true;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.edit.featureGroup = this.areaLayerView.layer;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break                </li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;if (options.edit.featureGroup){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.activeEditControl = new L.Control.Draw(options);            </li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.map.addControl(this.activeEditControl);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">}</li>
						</ol></code>
<p>
						toggleEditは、EditControlViewのボタンクリックイベントで送られてくるボタンの識別子(placeかrouteかareaか)によって、Draw プラグインのツールの種類と、編集対象となるL.FeatureGroupのオブジェクト(PointLayerView, RouteLayerView, AreaLayerViewのうちのどのlayerプロパティか)を切り替えています。
</p>
<p>
						ブラウザで確かめてみましょう。<br>
						青いボタンのいずれかをクリックして、プラグインのボタンを触ってみてください。<br>
						プラグインの一番上のボタンをクリックすると、新規入力モードになります。<br>
						2番目の編集ボタンをクリックすると、対象のL.FeatureGroupオブジェクトが編集可能な状態になっているのが分かると思います。<br>
						3番目の削除ボタンをクリックすると、削除モードになります。このモードで対象のL.FeatureGroupオブジェクトクリックすると、地図上から削除されます。
</p>
<p>
						しかし、これらの編集を行った後でページ右上のSaveボタンをクリックしても、サーバー上のGeoJSONは変更されません。<br>
						データに変化があったように見えるのは、地図の上だけで、実際のデータ（CollectionとModel）には何も変化していないからです。
</p>
					<p>次は、Drawプラグインでの入力・編集の結果を、実際のデータに反映させる処理を書いていきます。</p>

					</div>
					<hr id="a05">
					<div>
						<h3>Step05</h3>
						
						<p>Drawプラグインで入力したデータを追加できるようにしましょう。</p>
<p>
						Drawプラグインで地図上にあたららしいL.Layerオブジェクトが追加される時、L.Mapに"draw:created"というイベントが発生します。<br>
						このイベントオブジェクトは、追加されたL.Layerオブジェクトをlayerプロパティに持っています。<br>
						イベントを監視して、データを追加してやりましょう。
						下記のコードを、MapContainerViewのinitializeメソッドに追加してください。<br>
						PointLayerViewの呼び出しの前あたりがよいです。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>
						<li style="background-color:#EFF;">this.map.on(<font style="color:brown;">"draw:created"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;var layerView;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;switch(this.editControlView.activeType){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"place"</font>:</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layerView = this.pointLayerView;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"route"</font>:</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layerView = this.routeLayerView;</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case <font style="color:brown;">"area"</font>:</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layerView = this.areaLayerView;</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;if (layerView){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layerView.layerCreated(e.layer);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">},this);</li>
</strong>						
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">this.pointLayerView = new PointLayerView({collection:options.pointCollection});</li>
						</ol></code>

						<p>このイベントリスナーでやっていることは、下記の通りです。</p>
<ol>
						<li>EditoControlViewはactiveTypeプロパティに現在入力対象になっているデータ種別の識別子を保持しているので、それをもとに処理対象のViewを設定。<br><br></li>
						<li>処理対象のViewのlayerCreatedメソッドを、地図上に追加されたL.Layerオブジェクトを引数にして呼び出す。</li>
</ol>
						<p>では各xxxLayerViewのlayerCraetedメソッドを定義しましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 一時避難所データの集合(pointCollection)を扱うView</font></li>
						<li style="background-color:#EEF;">var PointLayerView = Backbone.View.extend(_.extend({},LayerMixin,{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureViewClass:function(){return PointView},</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;layerCreated:function(layer){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var latLng = layer.getLatLng();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.add(new models.PointModel({<font style="color:brown;">"coordinates"</font>:[latLng.lat,latLng.lng]}));</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EEF;">}));</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">（省略）</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;"><font style="color:green;font-style:italic;">// 避難経路データの集合(routeCollection)を扱うView</font></li>
						<li style="background-color:#EFF;">var PolylineLayerView = Backbone.View.extend(_.extend({},LayerMixin,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureViewClass:function(){return PolylineView},</li>
<strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;layerCreated:function(layer){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var coordinates = _.map(layer.getLatLngs(),function(c){return [c.lat,c.lng]});            </li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.add(new models.RouteModel({<font style="color:brown;">"coordinates"</font>:coordinates}));</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EFF;">}));</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">（省略）</li>
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;"><font style="color:green;font-style:italic;">// 避難対象区域データの集合(areaCollection)を扱うView</font></li>
						<li style="background-color:#EEF;">var PolygonLayerView = Backbone.View.extend(_.extend({},LayerMixin,{</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureViewClass : function(){return PolygonView},</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;layerCreated:function(layer){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var coordinates = [_.map(layer.getLatLngs(),function(c){return [c.lat,c.lng]})];</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.add(new models.AreaModel({<font style="color:brown;">"coordinates"</font>:coordinates}));</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EFF;">}));</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>


						<p>layerCreatedでやっている事は下記の通りです。</p>
<ol>
						<li>引数のlayer（L.Marker,L.Polyline, L.Polygon）の座標を取得し、L.LatLngオブジェクトを[緯度,経度]の配列に変換する。<br><br></li>
						<li>変換した座標データでモデルを作成し、collectionプロパティ(MapContainerViewの pointColleciton,routeCollection, areaCollectionと同じデータ)に追加する。</li>
</ol>
<p>
						つぎに、LayerMixinに、collectionプロパティにモデルが追加されたときの処理を定義します。<br>
						collectionプロパティの"add"イベントを監視して、addNewLayerを呼び出します。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var LayerMixin = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer = new L.FeatureGroup();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"reset"</font>,this.renderLayer,this);</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"add"</font>,this.addNewLayer,this);            </li>
</strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;renderLayer:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer.clearLayers();</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.each(function(m){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.addNewLayer(m);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},this);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;addNewLayer:function(m){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var modelView = new (this.getFeatureViewClass())({model:m});</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modelView.layer.addTo(this.layer);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">};</li>
						</ol></code>
<p>
						ブラウザで動作を確かめてみましょう。<br>
						「edit places」ボタンをクリックして一時避難所の入力ツールを表示させ、新しいマーカーを地図に追いみてください。
</p>
<p>
						やりました！地図上にマーカーが追加されましたね。<br>
						しかも、右側のリストにも新しい行が追加されています！リストのコードは全く触っていないというのに！
</p>

<p>
						からくりを説明すると、右側のリストのViewも避難所のコレクションの"add"イベントを監視していて、イベント発生時にが新しい行を追加するようにリスナーファンクションが定義されてあるのです。<br>
						ビューは、互いに直接やり取りをしなくても、モデルやコレクションを監視する事で緩くつながって、一つのアプリケーションをなしているのです。
						これがBackbone.jsの長所の一つです。
</p>

						
					</div>
					<hr id="a06">
					<div>
						<h3>Step06</h3>
<p>						
						次は、位置情報（座標）の変更がデータに反映されるにしましょう。
</p>

<p>
						DrawプラグインでL.Layerオブジェクトを編集して「OK」ボタンをクリックすると、マップに"draw:edited"というイベントが発生します。<br>
						イベントオブジェクトは、編集対象のL.LayerのL.FeatureGroupオブジェクトをlayersプロパティにもっています。<br>
						このイベントをMapContainerViewで監視しましょう。<br>
						下記のコードをPointLayerViewの呼び出しの前に追加してください。<br>
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>							
						<li style="background-color:#EFF;">this.map.on(<font style="color:brown;">"draw:edited"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;e.layers.eachLayer(function(l) {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;l.fire(<font style="color:brown;">"myApp:edited"</font>);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;});</li>
						<li style="background-color:#EFF;">},this);</li>
						<li style="background-color:#EEF;"></li>
</strong>						
						<li style="background-color:#EFF;">this.pointLayerView = new PointLayerView({collection:options.pointCollection});</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>
<p>
						このリスナーファンクションでは、イベントオブジェクトのlayersプロパティに含まれる個々のL.Layerオブジェクト(L.Marker / L.Polyline / L.Polygon)について、"myApp:edited"というイベントをトリガーしています。
</p>
<p>
						各L.Layerオブジェクトに対応するビューで、"myApp::edited"イベントのリスナーファンクションを定義しましょう。<br>
						リスナーファンクションですべき事は、L.Layerオブジェクトの座標をViewのモデルに反映する事だけです。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var FeatureMixin = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.renderLayer();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;renderLayer:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer = new (this.getFeatureClass())(this.model.get(<font style="color:brown;">"coordinates"</font>),this.featureOption);</li>
<strong>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer.on(<font style="color:brown;">"myApp:edited"</font>,this.layerEdited,this);</li>
</strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">（省略）</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;"><font style="color:green;font-style:italic;">// 一時避難所データ(pointCollectionのModel)を扱うView</font></li>
						<li style="background-color:#EFF;">var PointView = Backbone.View.extend(_.extend({},FeatureMixin,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureClass:function(){return L.Marker},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;featureOption: null,</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;layerEdited:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var latLng = this.layer.getLatLng();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.model.set(<font style="color:brown;">"coordinates"</font>,[latLng.lat,latLng.lng]);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EEF;">}));</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">（省略）</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;"><font style="color:green;font-style:italic;">// 避難経路データ(routeCollectionのModel)を扱うView</font></li>
						<li style="background-color:#EFF;">var PolylineView = Backbone.View.extend(_.extend({},FeatureMixin,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureClass:function(){return L.Polyline},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;featureOption: {opacity:1},        </li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;layerEdited:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var latLngs = this.layer.getLatLngs();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.model.set(<font style="color:brown;">"coordinates"</font>,_.map(latLngs,function(c){return [c.lat,c.lng]}));</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EEF;">}));</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;">（省略）</li>
						<li style="background-color:#EFF;"></li>
						<li style="background-color:#EEF;"><font style="color:green;font-style:italic;">// 避難対象区域データ(areaCollectionのModel)を扱うView </font></li>
						<li style="background-color:#EFF;">var PolygonView = Backbone.View.extend(_.extend({},FeatureMixin,{</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;getFeatureClass:function(){return L.Polygon},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;featureOption:{color:<font style="color:brown;">"#f00"</font>,fillColor:<font style="color:brown;">"#f00"</font>,fillOpacity:0.8},</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;layerEdited:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var coordinates =[ _.map(this.layer.getLatLngs(),function(c){return [c.lat,c.lng]})];</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.model.set(<font style="color:brown;">"coordinates"</font>,coordinates);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EEF;">}));</li>
						</ol></code>

						<p>
							これでDrawプラグインでの変更が実際のデータに反映されるようになったはずです。<br>
							実際に操作して、ページ右上の「Save」ボタンをクリックしてみましょう。
						</p>
						
					</div>
					<hr id="a07">
					<div>
						<h3>Step07</h3>

						<p>さあ、いよいよ最後の作業です。</p>
<p>
						データを削除できるようにしましょう。<br>
						DrawプラグインでL.Layerオブジェクトを削除して「OK」ボタン　を押した時、L.Mapに"draw:deleted"というイベントが発生します。<br>
						イベントオブジェクトは、編集対象のL.LayerのL.FeatureGroupオブジェクトをlayersプロパティにもっています。
</p>
<p>
						やる事は位置情報の変更の時とほとんど同じです。<br>
						このイベントをMapContainerViewで監視して、各L.Layerオブジェクトで"myApp:deleted"イベントをトリガーし、対応するビューで削除処理を定義すればよいですね。<br>
						下記のコードをPointLayerViewの呼び出しの前に追加してください。
</p>
						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
<strong>							
						<li style="background-color:#EFF;">this.map.on(<font style="color:brown;">"draw:deleted"</font>,function(e){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;e.layers.eachLayer(function(l) {</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;l.fire(<font style="color:brown;">"myApp:deleted"</font>);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;});                </li>
						<li style="background-color:#EFF;">},this);</li>
</strong>						
						<li style="background-color:#EEF;"></li>
						<li style="background-color:#EFF;">this.pointLayerView = new PointLayerView({collection:options.pointCollection});</li>
						<li style="background-color:#EEF;"></li>
						</ol></code>

						<p>削除の処理は共通化できそうです。FeatureMixinに"myApp::deleted"イベントのリスナーファンクションを定義します。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var FeatureMixin = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.renderLayer();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;renderLayer:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer = new (this.getFeatureClass())(this.model.get(<font style="color:brown;">"coordinates"</font>),this.featureOption);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer.on(<font style="color:brown;">"myApp:edited"</font>,this.layerEdited,this);</li>
<strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer.on(<font style="color:brown;">"myApp:deleted"</font>,this.layerDeleted,this);</li>
</strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
<strong>						
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;layerDeleted:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.trigger(<font style="color:brown;">"requestRemove"</font>);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
</strong>						
						<li style="background-color:#EEF;">};</li>
						<li style="background-color:#EFF;"></li>
						</ol></code>
<p>
						このリスナーファンクションは、「自分自身を削除して下さい」というメッセージを、"requestRemove"というイベントで発しています。<br>
						この上位のxxxLayerViewで削除してもらう事を意図しています。
</p>
						<p>LayerMixinに、"requestRemove"イベントを監視してデータを削除する処理を入れましょう。</p>

						<code>
						<ol style="list-style:decimal-leading-zero outside;in-left:0;padding-left:36px;margin:0;background-color:#EEF;color:#000;">
						<li style="background-color:#EFF;">var LayerMixin = {</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;initialize:function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer = new L.FeatureGroup();</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"reset"</font>,this.renderLayer,this);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(this.collection,<font style="color:brown;">"add"</font>,this.addNewLayer,this);            </li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;renderLayer:function(){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer.clearLayers();</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.each(function(m){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.addNewLayer(m);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},this);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;},</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;addNewLayer:function(m){</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var modelView = new (this.getFeatureViewClass())({model:m});</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modelView.layer.addTo(this.layer);</li>
<strong>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.listenTo(modelView,<font style="color:brown;">"requestRemove"</font>,function(){</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.layer.removeLayer(modelView.layer);</li>
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.collection.remove(m);</li>
						<li style="background-color:#EFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},this);</li>
</strong>						
						<li style="background-color:#EEF;">&nbsp;&nbsp;&nbsp;&nbsp;}</li>
						<li style="background-color:#EFF;">};</li>
						</ol></code>
<p>
						ブラウザで動作を確かめてみましょう。<br>
						いろいろデータを編集して、右上の「Save」ボタンをクリックしてみてください。<br>
						localhost:8000/gjsv に、編集結果が反映されていますね。
</p>

            <p class="text-info">
              ここまでの成果と同じものが、<code>＜教材をコピーしたフォルダ＞/application/js_results/r07/</code></a> にあります。上手く行かないところがある場合は、自分のコードと比べてみてください。
            </p>


						<p>おめでとうございます。アプリケーションが完成しました。</p>
						
<p>
						今日ご紹介したBackbone.jsへのLeafeltの導入方法は、決して唯一の正しい方法でなく、あくまで一つの例であり、他にも良い方法が考えられると思います。。
						それだけ、Leafletが柔軟なAPIであるとも言えます。
</p>
						<p>今日のセッションをきっかけに、皆さんがこれからもLeafletを使い続るだけでなく、周囲の方々にも広めていただければ、とてもうれしく思います。</p>

						<p>これで、ハンズオンセッションは終わりです。おつかれさまでした！</p>
						
					</div>


				</div>
			</div>
		</div>
	</body>
</html>
	